<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Marco Lógico - Gerador IA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding:24px 0 32px}
    h1{margin:0 0 8px;font-size:26px}
    .lead{color:var(--muted);margin:0}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:28px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .form-section{margin-bottom:28px}
    label{display:block;margin:12px 0 6px;font-weight:600;color:var(--ink)}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{resize:vertical;min-height:100px}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin:10px 0;font-size:13px}
    button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 24px;font-weight:600;cursor:pointer;font-size:16px;width:100%}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:14px 0 0;font-size:14px}
    .status.error{color:#d32f2f}.status.success{color:var(--green)}
    .objetivos-section{display:none;margin-top:20px}
    .objetivos-section.ativa{display:block}
    .objetivo-input-group{background:#f9f9f9;border:1px solid #e3e8ee;border-radius:8px;padding:16px;margin:10px 0}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Marco Lógico</h1>
    <p class="lead">Geração automática a partir do edital</p>
  </header>

  <main class="wrap">
    <form id="marcoForm" novalidate>
      <div class="form-section">
        <h2>Arquivo do edital</h2>
        <input type="file" id="edital" accept=".pdf,.docx,.txt" required>
        <div id="editalInfo" class="file-info" style="display:none"></div>
      </div>

      <div class="form-section">
        <h2>Projeto</h2>
        <input type="text" id="nomeProjeto" placeholder="Nome do projeto" required>
      </div>

      <div class="form-section">
        <h2>Descrição da proposta</h2>
        <textarea id="descricaoProposta" placeholder="Resumo do projeto, contexto, atividades e beneficiários" required></textarea>
      </div>

      <div class="form-section">
        <h2>Estrutura</h2>
        <select id="numObjetivos" required>
          <option value="">Número de objetivos específicos</option>
          <option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </div>

      <div class="form-section objetivos-section" id="objetivosSection">
        <h2>Objetivos específicos</h2>
        <div id="objetivosContainer"></div>
      </div>

      <button type="submit" id="submitBtn">Gerar marco lógico</button>
      <p id="status" class="status"></p>
    </form>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.min.js"></script>
  <script>
    const form = document.getElementById('marcoForm');
    const editalInput = document.getElementById('edital');
    const editalInfo = document.getElementById('editalInfo');
    const objetivosSection = document.getElementById('objetivosSection');
    const objetivosContainer = document.getElementById('objetivosContainer');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    const WEBHOOK_URL = 'https://hook.us2.make.com/6lkkytmbws4tvlep6aquy1yvt2l0glwm';

    let editalConteudo = '';

    function sanitizeJSONText(s){
      return String(s ?? '').replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\r?\n/g,' ');
    }
    function objetivosToOneLine(arr){
      if(!Array.isArray(arr)) return '';
      const clean = v => String(v ?? '').replace(/[\r\n]+/g,' ').replace(/"/g,'\\"').trim();
      return arr.map(o => `${o.numero}. ${clean(o.titulo)} | ${clean(o.descricao)}`).join(' || ');
    }

    // Parse tolerante, mas prioriza JSON puro do webhook
    function tryParseJSON(x){ try{ return JSON.parse(x); }catch{return null;} }
    function extractMarcoLogico(raw){
      if(!raw) throw new Error('vazio');
      if(typeof raw === 'object' && raw.marco_logico) return raw;
      const parsed = tryParseJSON(raw);
      if(parsed && parsed.marco_logico) return parsed;
      // fallback, tenta localizar início do objeto
      const s = String(raw).replace(/```json|```/g,'').replace(/\uFEFF/g,'').replace(/\r?\n/g,' ').trim();
      const i = s.indexOf('{"marco_logico"');
      if(i >= 0){
        let depth = 0, end = -1;
        for(let k=i;k<s.length;k++){
          const ch=s[k];
          if(ch==='{') depth++;
          else if(ch==='}'){ depth--; if(depth===0){ end=k; break; } }
        }
        if(end>i){
          const slice = s.slice(i,end+1);
          const j = tryParseJSON(slice);
          if(j && j.marco_logico) return j;
        }
      }
      throw new Error('Estrutura JSON inválida');
    }

    async function lerPDF(file){
      const buf = await file.arrayBuffer();
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      let txt = '';
      for(let i=1;i<=pdf.numPages;i++){
        const pg = await pdf.getPage(i);
        const c = await pg.getTextContent();
        txt += c.items.map(it=>it.str).join(' ') + ' ';
      }
      return txt;
    }
    async function lerDOCX(file){
      const buf = await file.arrayBuffer();
      const r = await mammoth.extractRawText({arrayBuffer:buf});
      return r.value;
    }

    editalInput.addEventListener('change', async e=>{
      const f = e.target.files[0];
      if(!f) return;
      statusEl.textContent = 'Lendo arquivo';
      statusEl.classList.remove('error','success');
      try{
        if(f.name.endsWith('.txt')) editalConteudo = await f.text();
        else if(f.name.endsWith('.pdf')) editalConteudo = await lerPDF(f);
        else if(f.name.endsWith('.docx')) editalConteudo = await lerDOCX(f);
        else throw new Error('Formato não suportado');
        editalInfo.style.display='block';
        editalInfo.textContent = `${f.name} carregado, ${(editalConteudo.length/1024).toFixed(1)} KB`;
        statusEl.textContent = '';
      }catch(err){
        statusEl.textContent = 'Erro, ' + err.message;
        statusEl.classList.add('error');
      }
    });

    document.getElementById('numObjetivos').addEventListener('change', e=>{
      const n = parseInt(e.target.value)||0;
      objetivosContainer.innerHTML = '';
      if(n>0){
        objetivosSection.classList.add('ativa');
        for(let i=1;i<=n;i++){
          const div = document.createElement('div');
          div.className='objetivo-input-group';
          div.innerHTML = `
            <h4>Objetivo ${i}</h4>
            <input type="text" name="oe_titulo_${i}" placeholder="Título do objetivo ${i}" required>
            <textarea name="oe_descricao_${i}" placeholder="Descrição do objetivo ${i}" required></textarea>
          `;
          objetivosContainer.appendChild(div);
        }
      }else{
        objetivosSection.classList.remove('ativa');
      }
    });

    form.addEventListener('submit', async e=>{
      e.preventDefault();

      if(!editalConteudo){
        statusEl.textContent='Carregue o edital';
        statusEl.classList.add('error');
        return;
      }
      const nomeProjeto = document.getElementById('nomeProjeto').value.trim();
      const descricaoProposta = document.getElementById('descricaoProposta').value.trim();
      const num = parseInt(document.getElementById('numObjetivos').value);

      if(!nomeProjeto || !descricaoProposta || !num){
        statusEl.textContent='Preencha todos os campos';
        statusEl.classList.add('error');
        return;
      }

      const objetivosEspecificos = [];
      for(let i=1;i<=num;i++){
        const titulo = form[`oe_titulo_${i}`].value.trim();
        const descricao = form[`oe_descricao_${i}`].value.trim();
        if(!titulo || !descricao){
          statusEl.textContent=`Preencha o objetivo ${i}`;
          statusEl.classList.add('error');
          return;
        }
        objetivosEspecificos.push({numero:i,titulo,descricao});
      }

      const payload = {
        edital: sanitizeJSONText(editalConteudo),
        nomeProjeto: sanitizeJSONText(nomeProjeto),
        descricaoProposta: sanitizeJSONText(descricaoProposta),
        objetivosEspecificos,                     // para uso local no XLSX
        objetivosEspecificosTexto: objetivosToOneLine(objetivosEspecificos) // para o prompt
      };

      try{
        submitBtn.disabled = true;
        statusEl.textContent = 'Processando';
        statusEl.classList.remove('error','success');

        const r = await fetch(WEBHOOK_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!r.ok) throw new Error('HTTP ' + r.status);

        // espere JSON puro do webhook, senão use fallback
        let marcoLogico;
        try{
          const j = await r.json(); // deve vir {marco_logico:{...}}
          marcoLogico = j;
        }catch{
          const txt = await r.text();
          marcoLogico = extractMarcoLogico(txt);
        }

        if(!marcoLogico?.marco_logico) throw new Error('Estrutura JSON inválida');

        statusEl.textContent = 'Marco lógico gerado, criando XLSX';
        statusEl.classList.add('success');
        gerarXLSX(marcoLogico, nomeProjeto);

      }catch(err){
        statusEl.textContent = 'Erro ao processar resposta, ' + err.message;
        statusEl.classList.add('error');
      }finally{
        submitBtn.disabled = false;
      }
    });

    function gerarXLSX(marco, nomeProjeto){
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
      script.onload = ()=>{
        try{
          const wb = XLSX.utils.book_new();
          const objetivos = marco.marco_logico?.objetivos_especificos || [];
          const totalResultados = objetivos.reduce((a,oe)=>a+(oe.resultados?.length||0),0);
          const totalIndicadores = objetivos.reduce((a,oe)=>a+(oe.resultados||[]).reduce((b,r)=>b+(r.indicadores?.length||0),0),0);
          const totalAtividades = objetivos.reduce((a,oe)=>a+(oe.resultados||[]).reduce((b,r)=>b+(r.atividades?.length||0),0),0);

          const resumo = [
            ['PROJETO', nomeProjeto],
            ['OBJETIVO GERAL', marco.marco_logico?.objetivo_geral || ''],
            ['DATA', new Date().toLocaleDateString('pt-BR')],
            [''],
            ['ESTATÍSTICAS'],
            ['Objetivos', objetivos.length],
            ['Resultados', totalResultados],
            ['Indicadores', totalIndicadores],
            ['Atividades', totalAtividades]
          ];
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(resumo), 'Resumo');

          const linhas = [['OE','RESULTADO','INDICADOR','META','ATIVIDADE','LÓGICA','PRAZO','VERIFICAÇÃO']];
          objetivos.forEach(oe=>{
            (oe.resultados||[]).forEach(r=>{
              const inds=r.indicadores||[];
              const atvs=r.atividades||[];
              const n=Math.max(inds.length,atvs.length,1);
              for(let i=0;i<n;i++){
                const ind=inds[i]||{}, atv=atvs[i]||{};
                linhas.push([
                  oe.titulo||'',
                  r.titulo||'',
                  ind.texto||'',
                  ind.meta||'',
                  atv.descricao||'',
                  atv.logica_intervencao||'',
                  atv.prazo||'',
                  atv.meios_verificacao||''
                ]);
              }
            });
          });
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(linhas), 'Marco Lógico');

          const filename = `Marco_Logico_${String(nomeProjeto).replace(/\s+/g,'_')}.xlsx`;
          XLSX.writeFile(wb, filename);
          statusEl.textContent = 'XLSX gerado';
          statusEl.classList.add('success');
        }catch(err){
          statusEl.textContent = 'Erro na criação do XLSX, ' + err.message;
          statusEl.classList.add('error');
        }
      };
      script.onerror = ()=>{
        statusEl.textContent = 'Falha ao carregar biblioteca XLSX';
        statusEl.classList.add('error');
      };
      document.head.appendChild(script);
    }
  </script>
</body>
</html>

