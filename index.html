<!doctype html><html lang="pt-br"><head><meta charset="utf-8"><title>Marco Logico — Parser Base64+GZIP robusto</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"><style>:root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}.wrap{max-width:980px;margin:0 auto;padding:20px}header{text-align:center;padding:16px 0}h1{margin:0 0 8px;font-size:26px}.lead{color:var(--muted)}form{background:#fff;border:1px solid #eee;border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.04)}label{display:block;margin:12px 0 6px;font-weight:600}input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:10px;font:inherit}textarea{min-height:110px;resize:vertical}.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:600;cursor:pointer;font-size:16px}button:disabled{opacity:.6;cursor:not-allowed}.status{min-height:22px;color:var(--muted);margin:10px 0 0;font-size:14px}.status.error{color:#c62828}.status.success{color:var(--green)}.debug{background:#f7f7f7;border:1px solid #e5e7eb;border-radius:10px;padding:12px;font:12px/1.4 ui-monospace,Consolas,monospace;white-space:pre-wrap;word-break:break-word;max-height:260px;overflow:auto;display:none}.table{margin-top:14px;background:#fff;border:1px solid #eee;border-radius:10px;overflow:auto}table{width:100%;border-collapse:collapse;font-size:14px}th,td{border-bottom:1px solid #eee;padding:8px 10px;vertical-align:top;word-break:break-word}th{background:#f6fbf6;color:#0f5132;text-align:left;position:sticky;top:0}.right{display:flex;gap:8px;justify-content:flex-end}</style></head><body><header class="wrap"><h1>Marco Logico</h1><p class="lead">Front robusto para respostas Base64+GZIP</p></header><main class="wrap"><form id="frm" novalidate><div class="row"><div><label>Nome do Projeto *</label><input id="nomeProjeto" required placeholder="Ex.: Promocao da Politica e Governanca Climatica"></div><div><label>Qtd. Objetivos Especificos *</label><select id="nOE" required><option value="">Selecione</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div></div><label>Descricao da Proposta *</label><textarea id="desc" required placeholder="Contexto, publico, resultados esperados"></textarea><label>Arquivo do Edital (PDF/DOCX/TXT) ou deixe em branco</label><input type="file" id="edital" accept=".pdf,.docx,.doc,.txt"><div id="oes"></div><div class="right" style="margin-top:12px"><button id="btn">Gerar Marco Logico</button></div><p id="status" class="status"></p></form><div id="diagBox" class="debug"></div><div id="previewBox" class="table" style="display:none"><table id="tbl"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody></tbody></table><div class="right" style="padding:10px"><button id="dlXlsx">Baixar XLSX</button></div></div></main><script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><script>const WEBHOOK_URL="https://hook.us2.make.com/6lkkytmbws4tvlep6aquy1yvt2l0glwm";const nOE=document.getElementById("nOE");const oesDiv=document.getElementById("oes");nOE.addEventListener("change",()=>{oesDiv.innerHTML="";const n=parseInt(nOE.value||0);for(let i=1;i<=n;i++){const wrap=document.createElement("div");wrap.innerHTML=`<div class="row" style="margin-top:10px"><div><label>OE ${i} — Titulo *</label><input required id="oe_t_${i}" placeholder="Titulo do objetivo ${i}"></div></div>`;oesDiv.appendChild(wrap)}});async function readFileText(file){if(!file)return"";if(file.type==="text/plain")return(await file.text()).slice(0,5e4);return""}function cleanB64Piece(s){if(!s)return"";let t=String(s).replace(/^```(?:json)?/i,"").replace(/```$/i,"").replace(/^['"]+|['"]+$/g,"").replace(/[\u200B-\u200F\u2028\u2029]/g,"").replace(/\s+/g,"").replace(/-/g,"+").replace(/_/g,"/").replace(/[^A-Za-z0-9+/=]/g,"");const m=t.length%4;if(m)t+="=".repeat(4-m);return t}function collectAllB64(raw){const txt=String(raw||"");const rx=/[A-Za-z0-9+/_=-]{40,}/g;const out=[];let m;while((m=rx.exec(txt))!==null)out.push(m[0]);return out}function b64ToBytesChunked(b64){const bin=atob(b64);const len=bin.length;const out=new Uint8Array(len);for(let i=0;i<len;i++)out[i]=bin.charCodeAt(i);return out}function isGzip(bytes){return bytes&&bytes.length>2&&bytes[0]===31&&bytes[1]===139}function utf8Decode(bytes){try{return new TextDecoder().decode(bytes)}catch{return String.fromCharCode.apply(null,bytes)}}function sliceToJsonEnvelope(txt){if(!txt)return"";const i=txt.indexOf("{"),j=txt.lastIndexOf("}");if(i!==-1&&j!==-1&&j>i)return txt.slice(i,j+1);return txt}function parseFromProvider(raw){const diag={stage:"start",pieces:0,joinedLen:0,gunzip:false,json:false,preview:""};const pieces=collectAllB64(raw);diag.pieces=pieces.length;let joined="";if(pieces.length>0){joined=pieces.map(cleanB64Piece).join("");const m=joined.length%4;if(m)joined+="=".repeat(4-m);diag.joinedLen=joined.length}else{try{const txt=sliceToJsonEnvelope(String(raw||""));const obj=JSON.parse(txt);diag.stage="json-direct";diag.json=true;diag.preview=txt.slice(0,160);return{ok:true,data:obj,diag}}catch(e){diag.stage="no-b64";diag.preview=String(raw||"").slice(0,160);throw Object.assign(new Error("Falha ao interpretar JSON da IA"),{diag})}}let bytes;try{bytes=b64ToBytesChunked(joined)}catch(e){diag.stage="invalid-b64";throw Object.assign(new Error("Falha ao interpretar JSON da IA"),{diag})}let txt="";try{if(isGzip(bytes)&&window.pako){const gunz=pako.ungzip(bytes);txt=utf8Decode(gunz);diag.gunzip=true}else{txt=utf8Decode(bytes)}}catch(e){txt=utf8Decode(bytes)}txt=txt.replace(/^\uFEFF/,"");let candidate=sliceToJsonEnvelope(txt).trim();diag.preview=candidate.slice(0,160);try{const obj=JSON.parse(candidate);diag.json=true;return{ok:true,data:obj,diag}}catch{const cleaned=candidate.replace(/,\s*([}\]])/g,"$1").replace(/[\u0000-\u001F\u007F]/g,"").trim();const obj2=JSON.parse(sliceToJsonEnvelope(cleaned));diag.json=true;return{ok:true,data:obj2,diag}}}function renderPreview(ml){const tb=document.querySelector("#tbl tbody");tb.innerHTML="";const push=(k,v)=>{const tr=document.createElement("tr");tr.innerHTML=`<td><b>${k}</b></td><td>${v||""}</td>`;tb.appendChild(tr)};push("Objetivo Geral",ml.objetivo_geral||"");(ml.objetivos_especificos||[]).forEach((oe,idx)=>{push(`Objetivo Especifico ${oe.numero||idx+1}`,`${oe.titulo||""}`);(oe.resultados||[]).forEach((r,i)=>{push(`Resultado ${oe.numero||idx+1}.${i+1}`,r.titulo||"");(r.indicadores||[]).forEach((ind,j)=>{push(`Indicador ${oe.numero||idx+1}.${i+1}.${j+1}`,`${ind.texto||""} | Meta: ${ind.meta||""} | MoV: ${(ind.meios_verificacao||[]).join("; ")}`)});(r.atividades||[]).forEach((a,j)=>{push(`Atividade ${oe.numero||idx+1}.${i+1}.${j+1}`,`${a.titulo||""} | Logica: ${a.logica_intervencao||""} | Prazo: ${a.prazo||""}`)})})});document.getElementById("previewBox").style.display="block"}function baixarXlsx(ml,nomeProjeto){const wb=XLSX.utils.book_new();const aoa=[["MARCO LOGICO"],["Objetivo Geral",ml.objetivo_geral||""]];(ml.objetivos_especificos||[]).forEach((oe,idx)=>{aoa.push([`Objetivo Especifico ${oe.numero||idx+1}`,`${oe.titulo||""}`]);aoa.push(["","Resultados","Indicadores","Meta","Meios de Verificacao"]);(oe.resultados||[]).forEach(r=>{const inds=r.indicadores||[];const max=Math.max(1,inds.length);for(let i=0;i<max;i++){const ind=inds[i]||{};aoa.push(["",i===0?(r.titulo||""):"",ind.texto||"",ind.meta||"",(ind.meios_verificacao||[]).join("; ")])}});aoa.push(["","Atividades","Logica de Intervencao","Prazo"]);(oe.resultados||[]).forEach(r=>{(r.atividades||[]).forEach(a=>{aoa.push(["",a.titulo||"",a.logica_intervencao||"",a.prazo||""])})})});const ws=XLSX.utils.aoa_to_sheet(aoa);ws["!cols"]=[{wch:26},{wch:40},{wch:42},{wch:16},{wch:42}];XLSX.utils.book_append_sheet(wb,ws,"Marco Logico");const safe=(nomeProjeto||"Projeto").replace(/[^a-zA-Z0-9]/g,"_").slice(0,30);XLSX.writeFile(wb,`Marco_Logico_${safe}_${Date.now()}.xlsx`)}const frm=document.getElementById("frm");const statusEl=document.getElementById("status");const diagBox=document.getElementById("diagBox");const btn=document.getElementById("btn");const dlBtn=document.getElementById("dlXlsx");let lastML=null;dlBtn.addEventListener("click",()=>{if(lastML)baixarXlsx(lastML,document.getElementById("nomeProjeto").value)});frm.addEventListener("submit",async e=>{e.preventDefault();try{btn.disabled=true;statusEl.textContent="Enviando ao Make...";diagBox.style.display="none";statusEl.classList.remove("error","success");const nomeProjeto=(document.getElementById("nomeProjeto").value||"").trim();const desc=(document.getElementById("desc").value||"").trim();const n=parseInt(nOE.value||0);if(!nomeProjeto||!desc||!n)throw new Error("Preencha nome, descricao e qtd. de objetivos.");const objetivosEspecificos=[];for(let i=1;i<=n;i++){const t=(document.getElementById(`oe_t_${i}`).value||"").trim();if(!t)throw new Error(`Preencha o titulo do OE ${i}.`);objetivosEspecificos.push({numero:i,titulo:t})}const file=document.getElementById("edital").files?.[0];const editalText=await readFileText(file);const payload={nomeProjeto,descricaoProposta:desc,objetivosEspecificos,objetivosEspecificosTexto:objetivosEspecificos.map(o=>`${o.numero}. ${o.titulo}`).join(" || "),edital:editalText};const res=await fetch(WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});const buf=new Uint8Array(await res.arrayBuffer());let bodyText="";if(buf&&buf.length){if(isGzip(buf)&&window.pako){bodyText=utf8Decode(pako.ungzip(buf))}else{bodyText=utf8Decode(buf)}}if(!res.ok){const preview=bodyText?bodyText.slice(0,200):`HTTP ${res.status}`;throw new Error(`HTTP ${res.status} | ${preview}`)}statusEl.textContent="Interpretando resposta da IA...";let parsed;try{parsed=parseFromProvider(bodyText)}catch(_e){/* fallback: alguns cenarios do Make retornam gzip sem base64 e sem json envoltorio */try{const txt=sliceToJsonEnvelope(bodyText);parsed={ok:true,data:JSON.parse(txt),diag:{stage:"fallback-json",pieces:0,joinedLen:0,gunzip:false,json:true,preview:txt.slice(0,160)}}}catch(e2){throw _e}}const data=parsed.data;const ml=data?.marco_logico||data;if(!ml||!ml.objetivos_especificos)throw new Error("JSON sem campo 'marco_logico' valido.");lastML=ml;renderPreview(ml);statusEl.textContent="✓ OK";statusEl.classList.add("success");diagBox.style.display="block";diagBox.textContent="Diagnostico do parser:\n"+JSON.stringify(parsed.diag,null,2)}catch(err){statusEl.textContent="Erro: "+err.message;statusEl.classList.add("error");diagBox.style.display="block";diagBox.textContent=(err.diag?"Diagnostico do parser:\n"+JSON.stringify(err.diag,null,2)+"\n\n":"")+(err.stack||String(err))}finally{btn.disabled=false}});</script></body></html>













