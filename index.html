<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Marco Lógico — Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    header{text-align:center;padding:20px 0}
    h1{margin:0 0 6px;font-size:26px}
    .lead{color:var(--muted);margin:0 0 12px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{resize:vertical;min-height:110px}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin:8px 0;font-size:13px}
    .objetivo-input-group{background:#f9f9f9;border:1px solid #e3e8ee;border-radius:8px;padding:12px;margin:8px 0}
    button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;font-size:16px;width:100%}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:12px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:#1E7E34}
    .debug-info{background:#f5f5f5;border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;font-family:monospace;max-height:400px;overflow-y:auto;display:none;white-space:pre-wrap;word-break:break-all}
    .debug-info.show{display:block}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Marco Lógico</h1>
    <p class="lead">Gerar a partir do edital e da proposta</p>
  </header>

  <main class="wrap">
    <form id="marcoForm" novalidate>
      <label>Arquivo do edital *
        <input type="file" id="edital" accept=".pdf,.docx,.doc,.txt" required>
      </label>
      <div id="editalInfo" class="file-info" style="display:none"></div>

      <label>Nome do Projeto *
        <input id="nomeProjeto" type="text" required placeholder="Ex: Turismo Regenerativo na Ilha do Bananal">
      </label>

      <label>Descrição da proposta *
        <textarea id="descricaoProposta" required placeholder="Contexto, atividades, público e resultados esperados"></textarea>
      </label>

      <label>Quantidade de objetivos específicos *
        <select id="numObjetivos" required>
          <option value="">Selecione</option>
          <option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option>
        </select>
      </label>

      <div id="objetivosContainer"></div>

      <button type="submit" id="submitBtn">Gerar marco lógico</button>
      <p id="status" class="status"></p>
      <div id="debugInfo" class="debug-info"></div>
    </form>
  </main>

  <script>
    const WEBHOOK_URL = 'https://hook.us2.make.com/6lkkytmbws4tvlep6aquy1yvt2l0glwm';

    // util
    function b64utf8(str){try{return btoa(unescape(encodeURIComponent(String(str))))}catch{return""}}
    function sanitizePlain(str){return String(str||"").replace(/[\u0000-\u001F\u007F]/g," ").replace(/\r/g," ").replace(/\t/g," ").replace(/\s+/g," ").trim()}
    function isLikelyBase64(s){if(!s) return false; const t=String(s).trim().replace(/\s+/g,''); return /^[A-Za-z0-9+/=]+$/.test(t) && t.length>=12}
    function b64ToBytes(b64){const t=String(b64||'').trim().replace(/\s+/g,''); const pad=t.length%4?t+'='.repeat(4-(t.length%4)):t; const bin=atob(pad); const out=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) out[i]=bin.charCodeAt(i); return out}
    function gunzipToString(bytes){try{const u8=pako.ungzip(bytes); return new TextDecoder('utf-8').decode(u8)}catch{return''}}

    async function readPDF(file){
      const buf=await file.arrayBuffer();
      const pdf=await pdfjsLib.getDocument({data:buf}).promise;
      let text=""; const max=30;
      for(let p=1;p<=Math.min(pdf.numPages,max);p++){
        const page=await pdf.getPage(p); const tc=await page.getTextContent();
        text+=tc.items.map(x=>x.str).join(" ")+" ";
      }
      return text.trim().substring(0,80000);
    }
    async function readDOCX(file){
      const buf=await file.arrayBuffer();
      const res=await mammoth.extractRawText({arrayBuffer:buf});
      return String(res.value||"").trim().substring(0,80000);
    }

    const form=document.getElementById('marcoForm');
    const editalInput=document.getElementById('edital');
    const editalInfo=document.getElementById('editalInfo');
    const numObjetivosSelect=document.getElementById('numObjetivos');
    const objetivosContainer=document.getElementById('objetivosContainer');
    const statusEl=document.getElementById('status');
    const submitBtn=document.getElementById('submitBtn');
    const debugInfo=document.getElementById('debugInfo');
    let editalConteudo="";

    editalInput.addEventListener('change',async(e)=>{
      const file=e.target.files[0]; if(!file) return;
      statusEl.textContent='Lendo arquivo...';
      try{
        const name=file.name.toLowerCase();
        if(name.endsWith('.txt'))editalConteudo=await file.text();
        else if(name.endsWith('.pdf'))editalConteudo=await readPDF(file);
        else if(name.endsWith('.docx')||name.endsWith('.doc'))editalConteudo=await readDOCX(file);
        else throw new Error('Formato não suportado');
        editalConteudo=sanitizePlain(editalConteudo);
        editalInfo.style.display='block';
        editalInfo.textContent=`✓ ${file.name} carregado — ${(editalConteudo.length/1024).toFixed(1)} KB`;
        statusEl.textContent='';
      }catch(err){statusEl.textContent='Erro: '+err.message;statusEl.classList.add('error');}
    });

    numObjetivosSelect.addEventListener('change',(e)=>{
      const n=parseInt(e.target.value)||0;
      objetivosContainer.innerHTML='';
      for(let i=1;i<=n;i++){
        const div=document.createElement('div');
        div.className='objetivo-input-group';
        div.innerHTML=`<strong>Objetivo Específico ${i}</strong>
          <input type='text' name='oe_titulo_${i}' placeholder='Título do objetivo ${i}' required>
          <textarea name='oe_descricao_${i}' placeholder='Descrição do objetivo ${i}' required></textarea>`;
        objetivosContainer.appendChild(div);
      }
    });

    function parseFromProvider(body){
      const raw=String(body||'').trim().replace(/^```(?:json)?\s*/i,'').replace(/```$/,'').trim();

      // JSON direto
      try{
        const j=JSON.parse(raw);
        if(j && j.marco_logico) return j;
        if(j && typeof j.b64==='string'){
          const bytes=b64ToBytes(j.b64);
          const dec=gunzipToString(bytes);
          if(dec.startsWith('{"marco_logico"')) return JSON.parse(dec);
        }
      }catch(_){}

      // Base64 puro → tenta GZIP → JSON
      if(isLikelyBase64(raw)){
        const bytes=b64ToBytes(raw);
        const dec=gunzipToString(bytes);
        if(dec && dec.startsWith('{"marco_logico"') && dec.trim().endsWith('}')) return JSON.parse(dec);
        throw new Error('Conteúdo Base64/GZIP inválido ou truncado');
      }

      // Fallback tolerante
      let s=raw.replace(/[\u0000-\u001F\u007F]/g,' ').replace(/\r?\n/g,' ').replace(/\t/g,' ');
      s=s.replace(/\\(?!["\\/bfnrtu])/g,'\\\\');
      const start=s.indexOf('{"marco_logico"'); if(start>-1) s=s.slice(start);
      const end=s.lastIndexOf('}'); if(end>-1) s=s.slice(0,end+1);
      try{ return JSON.parse(s); }catch{
        const s2=s.replace(/,(\s*[}\]])/g,'$1'); return JSON.parse(s2);
      }
    }

    function gerarXLSX(data, nomeProjeto){
      const ml = data?.marco_logico||{};
      const objetivos = Array.isArray(ml.objetivos_especificos)?ml.objetivos_especificos:[];
      const wb = XLSX.utils.book_new();
      const aoa = []; const merges = [];
      const T = v => String(v??'').trim();
      const join = a => Array.isArray(a)?a.join('; '):String(a??'');

      aoa.push(['MARCO LÓGICO']); merges.push({s:{r:0,c:0},e:{r:0,c:7}});
      aoa.push(['Objetivo Geral', T(ml.objetivo_geral)]); merges.push({s:{r:1,c:1},e:{r:1,c:7}});

      objetivos.forEach((obj,oi)=>{
        aoa.push([`Objetivo Específico ${obj.numero||oi+1}`, T(obj.titulo||obj.descricao)]); merges.push({s:{r:aoa.length-1,c:1},e:{r:aoa.length-1,c:7}});
        const res = Array.isArray(obj.resultados)?obj.resultados:[];
        const start = aoa.length;
        aoa.push(['', 'Resultados', 'Indicadores', 'Meta', 'Meios de Verificação', '', '', '']);

        let ln=0;
        res.forEach((r)=>{
          const inds = Array.isArray(r.indicadores)?r.indicadores:[];
          const max = Math.max(1, inds.length);
          for(let i=0;i<max;i++){
            const ind = inds[i]||{};
            aoa.push(['', i===0?T(r.titulo):'', T(ind.texto), T(ind.meta), join(ind.meios_verificacao||r.meios_verificacao||[]), '', '', '']);
            ln++;
          }
        });
        if(ln===0){ aoa.push(['','Sem resultados definidos','','','','','','']); ln=1; }
        aoa[start+1][0] = `RESULTADOS OBJETIVO ${obj.numero||oi+1}`;
        merges.push({s:{r:start+1,c:0},e:{r:start+ln,c:0}});

        aoa.push(['', 'Atividades', 'Lógica de Intervenção', 'Prazo', '', '', '', '']);
        const acts=[];
        res.forEach((r,ri)=>{
          (Array.isArray(r.atividades)?r.atividades:[]).forEach((a,ai)=>{
            acts.push(['', `Atividade ${oi+1}.${ri+1}.${ai+1}: ${T(a.titulo||a.descricao)}`, T(a.logica_intervencao||a.logica||''), T(a.prazo||''), '', '', '', '']);
          });
        });
        if(acts.length===0) acts.push(['','Sem atividades definidas','','','','','','']);
        acts.forEach(row=>aoa.push(row));
      });

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols'] = [{wch:28},{wch:44},{wch:60},{wch:18},{wch:44},{wch:4},{wch:4},{wch:4}];
      ws['!merges'] = merges;

      if(!ws['!rows']) ws['!rows']=[];
      for(let r=0;r<aoa.length;r++){
        const addrs=['A','B','C','D','E'].map(c=>c+(r+1));
        addrs.forEach(addr=>{
          if(!ws[addr]) ws[addr]={v:''};
          ws[addr].s={alignment:{wrapText:true,vertical:'top',horizontal:'left'},font:{name:'Calibri',sz:11}};
        });
        const len = addrs.slice(1).map(a=>String(ws[a].v||'').length).reduce((a,b)=>a+b,0);
        const est = Math.max(1, Math.ceil(len/120));
        ws['!rows'][r]={hpx: Math.min(260, 22 + est*18)};
      }

      XLSX.utils.book_append_sheet(wb, ws, 'Marco Lógico');

      const wsR = XLSX.utils.aoa_to_sheet([
        ['RESUMO'],[''],
        ['Projeto', String(nomeProjeto||'')],
        ['Data', new Date().toLocaleDateString('pt-BR')]
      ]);
      wsR['!cols']=[{wch:16},{wch:80}];
      XLSX.utils.book_append_sheet(wb, wsR, 'Resumo');

      const nomeSeguro = String(nomeProjeto||'Projeto').replace(/[^a-zA-Z0-9_-]/g,'_').substring(0,40);
      XLSX.writeFile(wb, `Marco_Logico_${nomeSeguro}_${Date.now()}.xlsx`);
    }

    form.addEventListener('submit',async(e)=>{
      e.preventDefault();
      statusEl.textContent=''; statusEl.classList.remove('error','success');
      debugInfo.classList.remove('show'); debugInfo.textContent='';

      if(!editalConteudo){statusEl.textContent='Carregue o edital';statusEl.classList.add('error');return;}

      const nomeProjeto=sanitizePlain(document.getElementById('nomeProjeto').value);
      const descricaoProposta=sanitizePlain(document.getElementById('descricaoProposta').value);
      const n=parseInt(numObjetivosSelect.value)||0;
      if(!nomeProjeto||!descricaoProposta||!n){statusEl.textContent='Preencha os campos obrigatórios';statusEl.classList.add('error');return;}

      const objetivosEspecificos=[];
      for(let i=1;i<=n;i++){
        const t=sanitizePlain(form[`oe_titulo_${i}`].value);
        const d=sanitizePlain(form[`oe_descricao_${i}`].value);
        if(!t||!d){statusEl.textContent=`Complete o objetivo ${i}`;statusEl.classList.add('error');return;}
        objetivosEspecificos.push({numero:i,titulo:t.substring(0,200),descricao:d.substring(0,500)});
      }
      const objetivosEspecificosTexto=objetivosEspecificos.map(o=>`${o.numero}. ${o.titulo} | ${o.descricao}`).join(' || ');

      const payload={
        edital_b64:b64utf8(editalConteudo),
        nomeProjeto_b64:b64utf8(nomeProjeto),
        descricaoProposta_b64:b64utf8(descricaoProposta),
        objetivosEspecificosTexto_b64:b64utf8(objetivosEspecificosTexto),
        objetivosEspecificos,
        type:'marco_logico'
      };

      try{
        submitBtn.disabled=true; submitBtn.textContent='Processando...';
        statusEl.textContent='Enviando para o Make';
        const resp=await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const body=await resp.text();
        if(!resp.ok) throw new Error(`HTTP ${resp.status} | ${body.slice(0,400)}`);
        if (body.includes('"stop_reason":"max_tokens"')) throw new Error('Resposta truncada pelo provedor (max_tokens)');

        const data = parseFromProvider(body);
        gerarXLSX(data, nomeProjeto);
        statusEl.textContent='✓ Marco lógico gerado com sucesso';
        statusEl.classList.add('success');
      }catch(err){
        statusEl.textContent='Erro: '+err.message;
        statusEl.classList.add('error');
        debugInfo.textContent=err.stack||String(err);
        debugInfo.classList.add('show');
      }finally{
        submitBtn.disabled=false; submitBtn.textContent='Gerar marco lógico';
      }
    });
  </script>
</body>
</html>




