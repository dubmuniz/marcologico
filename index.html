<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Marco Lógico — Parser tolerante (H4sIA/JSON)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header{text-align:center;padding:16px 0}
    h1{margin:0 0 8px;font-size:26px}
    .lead{color:var(--muted)}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:10px;font:inherit}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:600;cursor:pointer;font-size:16px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:10px 0 0;font-size:14px}
    .status.error{color:#c62828}
    .status.success{color:var(--green)}
    .debug{background:#f7f7f7;border:1px solid #e5e7eb;border-radius:10px;padding:12px;font:12px/1.4 ui-monospace,Consolas,monospace;white-space:pre-wrap;word-break:break-word;max-height:320px;overflow:auto;display:none}
    .table{margin-top:14px;background:#fff;border:1px solid #eee;border-radius:10px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #eee;padding:8px 10px;vertical-align:top;word-break:break-word}
    th{background:#f6fbf6;color:#0f5132;text-align:left;position:sticky;top:0}
    .right{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Marco Lógico</h1>
    <p class="lead">Aceita JSON direto ou Base64+GZIP (H4sIA…)</p>
  </header>

  <main class="wrap">
    <form id="frm" novalidate>
      <div class="row">
        <div>
          <label>Nome do Projeto *</label>
          <input id="nomeProjeto" required placeholder="Ex.: Promoção da Política e Governança Climática">
        </div>
        <div>
          <label>Qtd. Objetivos Específicos *</label>
          <select id="nOE" required>
            <option value="">Selecione</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
      </div>

      <label>Descrição da Proposta *</label>
      <textarea id="desc" required placeholder="Contexto, público, resultados esperados"></textarea>

      <label>Arquivo do Edital (PDF/DOCX/TXT) ou deixe em branco</label>
      <input type="file" id="edital" accept=".pdf,.docx,.doc,.txt">

      <div id="oes"></div>

      <div class="right" style="margin-top:12px">
        <button id="btn">Gerar Marco Lógico</button>
      </div>
      <p id="status" class="status"></p>
    </form>

    <div id="diagBox" class="debug"></div>

    <div id="previewBox" class="table" style="display:none">
      <table id="tbl"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody></tbody></table>
      <div class="right" style="padding:10px">
        <button id="dlXlsx">Baixar XLSX</button>
      </div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // ====== CONFIG ======
    const WEBHOOK_URL = "https://hook.us2.make.com/6lkkytmbws4tvlep6aquy1yvt2l0glwm";

    // ====== UI OEs: só título ======
    const nOE = document.getElementById('nOE');
    const oesDiv = document.getElementById('oes');
    nOE.addEventListener('change', () => {
      oesDiv.innerHTML = '';
      const n = parseInt(nOE.value||0);
      for (let i=1;i<=n;i++){
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <div class="row" style="margin-top:10px">
            <div>
              <label>OE ${i} — Título *</label>
              <input required id="oe_t_${i}" placeholder="Título do objetivo ${i}">
            </div>
          </div>`;
        oesDiv.appendChild(wrap);
      }
    });

    // ====== Utils ======
    function isGzip(bytes){ return bytes && bytes.length>2 && bytes[0]===0x1f && bytes[1]===0x8b; }
    function utf8Decode(bytes){
      try{ return new TextDecoder('utf-8',{fatal:false}).decode(bytes); }
      catch{ return String.fromCharCode.apply(null, bytes); }
    }
    function sliceToJsonEnvelope(txt){
      if(!txt) return "";
      const i = txt.indexOf("{"), j = txt.lastIndexOf("}");
      if(i!==-1 && j!==-1 && j>i) return txt.slice(i, j+1);
      return txt;
    }
    function collectAllB64(raw){
      const txt = String(raw||"");
      const rx = /[A-Za-z0-9+/_=-]{16,}/g;
      const out = []; let m;
      while((m = rx.exec(txt)) !== null){ out.push(m[0]); }
      return out;
    }
    function cleanB64Piece(s){
      if(!s) return "";
      let t = String(s)
        .replace(/^```(?:json)?/i,"").replace(/```$/i,"")
        .replace(/^['"]+|['"]+$/g,"")
        .replace(/[\u200B-\u200F\u2028\u2029]/g,"")
        .replace(/\s+/g,"")
        .replace(/-/g,"+").replace(/_/g,"/")
        .replace(/[^A-Za-z0-9+/=]/g,"");
      const m = t.length % 4; if (m) t += "=".repeat(4-m);
      return t;
    }
    function b64ToBytes(b64){
      const bin = atob(b64);
      const out = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
      return out;
    }

    // Tenta decodificar um string Base64 (possivelmente percent-encoded, sem padding, ou levemente truncado)
    function tryDecodeB64GzipLoose(b64Like, maxTrim=12){
      let s = b64Like.trim();

      // 1) desfaz percent-encoding se houver
      try{
        if (/%[0-9A-Fa-f]{2}/.test(s)) s = decodeURIComponent(s);
      }catch{}

      // 2) limpeza/padding
      s = cleanB64Piece(s);

      // 3) tentativa direta
      try{
        const b = b64ToBytes(s);
        const inner = isGzip(b) ? pako.ungzip(b) : b;
        return utf8Decode(inner);
      }catch{}

      // 4) tolerância a finais corrompidos: recorta do fim e tenta de novo
      for (let cut=1; cut<=maxTrim && s.length>32; cut++){
        let cand = s.slice(0, s.length - cut);
        const m = cand.length % 4; if (m) cand += "=".repeat(4-m);
        try{
          const b = b64ToBytes(cand);
          const inner = isGzip(b) ? pako.ungzip(b) : b;
          return utf8Decode(inner);
        }catch{}
      }
      throw new Error("decode-b64-loose-failed");
    }

    // ====== Parser ======
    function parseProviderResponseFull(bytes, contentTypeHeader){
      const diag = { stage:"start", gunzip:false, steps:[], contentType: contentTypeHeader||null, preview:"" };

      // TEXTO COMPLETO
      let textFull = "";
      if (bytes && bytes.length){
        try{ textFull = utf8Decode(bytes).trim(); }catch{ textFull=""; }
      }
      if (!textFull){
        throw Object.assign(new Error("Resposta vazia"), {diag});
      }

      // A) JSON direto
      try{
        const cand = sliceToJsonEnvelope(textFull.replace(/^\uFEFF/,"")).trim();
        const obj = JSON.parse(cand);
        diag.stage="json-direct";
        diag.preview=cand.slice(0,160);
        return {ok:true, data:obj, diag};
      }catch(e){ diag.steps.push("json-direct-failed"); }

      // B) String inteira parece Base64/H4sIA
      const looksB64 = /^H4sIA|^[A-Za-z0-9+/=_-]+$/.test(textFull);
      if (looksB64){
        try{
          const innerText = tryDecodeB64GzipLoose(textFull, 24);
          const cand = sliceToJsonEnvelope(innerText).trim();
          const obj = JSON.parse(cand);
          diag.stage = "fulltext-b64-loose";
          diag.gunzip = true;
          diag.preview = cand.slice(0,160);
          return { ok:true, data:obj, diag };
        }catch(e){ diag.steps.push("fulltext-b64-loose-failed"); }
      }

      // C) JSON com campo b64
      try{
        const probe = JSON.parse(sliceToJsonEnvelope(textFull));
        const keys = ["marco_logico_b64","body","data","file","content","payload","bytes","response"];
        for (const k of keys){
          const v = probe && probe[k];
          if (typeof v === "string" && v.length >= 16){
            try{
              const innerText = tryDecodeB64GzipLoose(v, 24);
              const cand = sliceToJsonEnvelope(innerText).trim();
              const obj = JSON.parse(cand);
              diag.stage = `json-field-${k}-b64-loose`;
              diag.gunzip = true;
              diag.preview = cand.slice(0,160);
              return { ok:true, data:obj, diag };
            }catch(e){}
          }
        }
        diag.steps.push("json-field-b64-loose-failed");
      }catch(e){ diag.steps.push("outer-json-probe-failed"); }

      // D) Varredura de múltiplos blocos b64
      try{
        const pieces = collectAllB64(textFull);
        if (pieces.length){
          const joined = pieces.map(cleanB64Piece).join("");
          const innerText = tryDecodeB64GzipLoose(joined, 24);
          const cand = sliceToJsonEnvelope(innerText).trim();
          const obj = JSON.parse(cand);
          diag.stage = "scan-b64-joined-loose";
          diag.gunzip = true;
          diag.preview = cand.slice(0,160);
          return { ok:true, data:obj, diag };
        }
        diag.steps.push("scan-b64-none");
      }catch(e){ diag.steps.push("scan-b64-joined-loose-failed"); }

      diag.stage = "text-fallback";
      diag.preview = textFull.slice(0,200);
      throw Object.assign(new Error("Falha ao interpretar resposta do provedor"), {diag});
    }

    // ====== Prévia ======
    function renderPreview(ml){
      const tb = document.querySelector('#tbl tbody'); tb.innerHTML = "";
      const push = (k,v)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><b>${k}</b></td><td>${v||''}</td>`; tb.appendChild(tr); };

      push("Objetivo Geral", ml.objetivo_geral||"");
      (ml.objetivos_especificos||[]).forEach((oe,idx)=>{
        push(`Objetivo Específico ${oe.numero||idx+1}`, `${oe.titulo||''}`);
        (oe.resultados||[]).forEach((r,i)=>{
          push(`Resultado ${oe.numero||idx+1}.${i+1}`, r.titulo||'');
          (r.indicadores||[]).forEach((ind,j)=>{
            push(`Indicador ${oe.numero||idx+1}.${i+1}.${j+1}`, `${ind.texto||''} | Meta: ${ind.meta||''} | MoV: ${(ind.meios_verificacao||[]).join('; ')}`);
          });
          (r.atividades||[]).forEach((a,j)=>{
            push(`Atividade ${oe.numero||idx+1}.${i+1}.${j+1}`, `${a.titulo||''} | Lógica: ${a.logica_intervencao||''} | Prazo: ${a.prazo||''}`);
          });
        });
      });

      document.getElementById('previewBox').style.display = 'block';
    }

    // ====== XLSX ======
    function baixarXlsx(ml, nomeProjeto){
      const wb = XLSX.utils.book_new();
      const aoa=[["MARCO LÓGICO"],["Objetivo Geral", ml.objetivo_geral||""]];
      (ml.objetivos_especificos||[]).forEach((oe,idx)=>{
        aoa.push([`Objetivo Específico ${oe.numero||idx+1}`, `${oe.titulo||''}`]);
        aoa.push(["","Resultados","Indicadores","Meta","Meios de Verificação"]);
        (oe.resultados||[]).forEach((r)=>{
          const inds = r.indicadores||[];
          const max = Math.max(1, inds.length);
          for(let i=0;i<max;i++){
            const ind = inds[i]||{};
            aoa.push(["", i===0?(r.titulo||''):"", ind.texto||"", ind.meta||"", (ind.meios_verificacao||[]).join("; ")]);
          }
        });
        aoa.push(["","Atividades","Lógica de Intervenção","Prazo"]);
        (oe.resultados||[]).forEach((r)=>{
          (r.atividades||[]).forEach((a)=>{
            aoa.push(["", a.titulo||"", a.logica_intervencao||"", a.prazo||""]);
          });
        });
      });
      const ws=XLSX.utils.aoa_to_sheet(aoa); ws['!cols']=[{wch:26},{wch:40},{wch:42},{wch:16},{wch:42}];
      XLSX.utils.book_append_sheet(wb, ws, "Marco Lógico");
      const safe=(nomeProjeto||'Projeto').replace(/[^a-zA-Z0-9]/g,'_').slice(0,30);
      XLSX.writeFile(wb, `Marco_Logico_${safe}_${Date.now()}.xlsx`);
    }

    // ====== Envio ======
    const frm = document.getElementById('frm');
    const statusEl = document.getElementById('status');
    const diagBox = document.getElementById('diagBox');
    const dlBtn = document.getElementById('dlXlsx');
    let lastML = null;

    dlBtn.addEventListener('click', ()=>{ if(lastML) baixarXlsx(lastML, document.getElementById('nomeProjeto').value); });

    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        statusEl.textContent = "Enviando...";
        statusEl.classList.remove('error','success');
        diagBox.style.display='none'; diagBox.textContent='';

        const nomeProjeto = (document.getElementById('nomeProjeto').value||"").trim();
        const desc = (document.getElementById('desc').value||"").trim();
        const n = parseInt(nOE.value||0);
        if(!nomeProjeto || !desc || !n) throw new Error("Preencha nome, descrição e qtd. de objetivos.");

        const objetivosEspecificos=[];
        for(let i=1;i<=n;i++){
          const t = (document.getElementById(`oe_t_${i}`).value||"").trim();
          if(!t) throw new Error(`Preencha o título do OE ${i}.`);
          objetivosEspecificos.push({numero:i,titulo:t});
        }

        let editalText = '';
        const file = document.getElementById('edital').files?.[0];
        if (file && file.type === 'text/plain') {
          editalText = (await file.text()).slice(0,50000);
        }

        const payload = {
          nomeProjeto, descricaoProposta: desc, objetivosEspecificos,
          objetivosEspecificosTexto: objetivosEspecificos.map(o=>`${o.numero}. ${o.titulo}`).join(' || '),
          edital: editalText
        };

        // POST minimalista para reduzir preflight
        const res = await fetch(WEBHOOK_URL,{
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=UTF-8'},
          body: JSON.stringify(payload)
        });

        const contentType = res.headers.get('content-type')||'';
        const buf = new Uint8Array(await res.arrayBuffer());

        if(!res.ok){
          let preview = "";
          try{ preview = utf8Decode(buf).slice(0,200); }catch{}
          throw new Error(`HTTP ${res.status} | ${preview}`);
        }
        if(!buf || !buf.length){
          throw Object.assign(new Error("Resposta vazia"), {diag:{stage:"no-bytes",contentType}});
        }

        statusEl.textContent = "Interpretando resposta...";

        // JSON direto (se o cenário devolver JSON)
        if (contentType.includes('application/json')){
          try{
            const text = utf8Decode(buf);
            const obj = JSON.parse(sliceToJsonEnvelope(text));
            const ml = obj?.marco_logico || obj;
            if(ml && ml.objetivos_especificos){
              lastML = ml; renderPreview(ml);
              statusEl.textContent = "✓ OK"; statusEl.classList.add('success');
              diagBox.style.display='block';
              diagBox.textContent = "Diagnóstico do parser:\n" + JSON.stringify({stage:"json-direct", contentType},null,2);
              return;
            }
          }catch(e){}
        }

        // H4sIA/variações e demais casos
        const parsed = parseProviderResponseFull(buf, contentType);
        const data = parsed.data;
        const ml = data?.marco_logico || data;
        if(!ml || !ml.objetivos_especificos){ throw new Error("JSON sem campo 'marco_logico' válido."); }

        lastML = ml;
        renderPreview(ml);
        statusEl.textContent = "✓ OK";
        statusEl.classList.add('success');

        diagBox.style.display='block';
        diagBox.textContent = "Diagnóstico do parser:\n" + JSON.stringify(parsed.diag,null,2);
      }catch(err){
        statusEl.textContent = "Erro: " + err.message;
        statusEl.classList.add('error');
        diagBox.style.display='block';
        diagBox.textContent = (err.diag ? "Diagnóstico do parser:\n"+JSON.stringify(err.diag,null,2)+"\n\n" : "") + (err.stack||String(err));
      }
    });
  </script>
</body>
</html>










