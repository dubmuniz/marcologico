<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Marco L√≥gico - Gerador IA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--green:#1E7E34;--accent:#FFC857;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding:28px 0 40px}
    h1{margin:0 0 10px;font-size:28px}
    .lead{color:var(--muted);margin:0}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:30px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .form-section{margin-bottom:32px}
    label{display:block;margin:16px 0 6px;font-weight:600;color:var(--ink)}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{resize:vertical;min-height:100px}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:12px;border-radius:6px;margin:12px 0;font-size:13px}
    button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 24px;font-weight:600;cursor:pointer;font-size:16px;width:100%}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:16px 0 0;font-size:14px}
    .status.error{color:#d32f2f}.status.success{color:var(--green)}
    .objetivos-section{display:none;margin-top:30px}
    .objetivos-section.ativa{display:block}
    .objetivo-input-group{background:#f9f9f9;border:1px solid #e3e8ee;border-radius:8px;padding:16px;margin:12px 0}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>üéØ Marco L√≥gico</h1>
    <p class="lead">Gere marcos l√≥gicos automaticamente com IA a partir do edital</p>
  </header>

  <main class="wrap">
    <form id="marcoForm" novalidate>
      <div class="form-section">
        <h2>üìÑ Edital</h2>
        <input type="file" id="edital" accept=".pdf,.docx,.txt" required>
        <div id="editalInfo" class="file-info" style="display:none"></div>
      </div>

      <div class="form-section">
        <h2>üè∑Ô∏è Projeto</h2>
        <input type="text" id="nomeProjeto" placeholder="Nome do projeto" required>
      </div>

      <div class="form-section">
        <h2>‚úçÔ∏è Descri√ß√£o da Proposta</h2>
        <textarea id="descricaoProposta" placeholder="Descreva brevemente a proposta" required></textarea>
      </div>

      <div class="form-section">
        <h2>üìä Estrutura</h2>
        <select id="numObjetivos" required>
          <option value="">N√∫mero de objetivos...</option>
          <option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
        </select>
      </div>

      <div class="form-section objetivos-section" id="objetivosSection">
        <h2>üìå Objetivos Espec√≠ficos</h2>
        <div id="objetivosContainer"></div>
      </div>

      <button type="submit" id="submitBtn">üöÄ Gerar Marco L√≥gico</button>
      <p id="status" class="status"></p>
    </form>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.min.js"></script>
  <script>
    const form = document.getElementById('marcoForm');
    const editalInput = document.getElementById('edital');
    const editalInfo = document.getElementById('editalInfo');
    const objetivosSection = document.getElementById('objetivosSection');
    const objetivosContainer = document.getElementById('objetivosContainer');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    let editalConteudo = '';

    function sanitizeJSONText(s){return String(s??'').replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\r?\n/g,' ');}
    function objetivosToOneLine(arr){
      if(!Array.isArray(arr))return '';
      const clean=s=>String(s??'').replace(/[\r\n]+/g,' ').replace(/"/g,'\\"').trim();
      return arr.map(o=>`${o.numero}. ${clean(o.titulo)} | ${clean(o.descricao)}`).join(' || ');
    }

    // Fun√ß√£o ultra-agressiva para extrair JSON
    function extractMarcoLogico(raw) {
      if (!raw) throw new Error('Resposta vazia');
      
      try {
        let txt = String(raw).trim();
        
        console.log('=== LIMPEZA AGRESSIVA ===');
        console.log('Resposta original (primeiros 500):', txt.substring(0, 500));
        
        // Estrat√©gia 1: Tenta encontrar JSON v√°lido em qualquer lugar da string
        // Procura por padr√£o {"marco_logico": em qualquer lugar
        const jsonPattern = /\{"marco_logico"\s*:\s*\{[\s\S]*?\}\s*\}/;
        const match = txt.match(jsonPattern);
        
        if (match) {
          console.log('‚úì Padr√£o JSON encontrado via regex');
          const cleaned = match[0];
          const obj = JSON.parse(cleaned);
          if (obj.marco_logico) return obj;
        }
        
        // Estrat√©gia 2: Remove TUDO que n√£o seja JSON
        // Remove qualquer coisa antes do primeiro {
        let startIdx = txt.indexOf('{');
        if (startIdx === -1) {
          // Tenta encontrar ap√≥s remover markdown
          txt = txt.replace(/```[a-z]*\n?/gi, '').replace(/```/g, '');
          startIdx = txt.indexOf('{');
        }
        
        if (startIdx > -1) {
          // Conta chaves para encontrar o JSON completo
          let depth = 0;
          let endIdx = -1;
          let inString = false;
          let escape = false;
          
          for (let i = startIdx; i < txt.length; i++) {
            const char = txt[i];
            
            if (escape) {
              escape = false;
              continue;
            }
            
            if (char === '\\') {
              escape = true;
              continue;
            }
            
            if (char === '"' && !escape) {
              inString = !inString;
              continue;
            }
            
            if (!inString) {
              if (char === '{') depth++;
              if (char === '}') {
                depth--;
                if (depth === 0) {
                  endIdx = i;
                  break;
                }
              }
            }
          }
          
          if (endIdx > -1) {
            const jsonStr = txt.substring(startIdx, endIdx + 1);
            console.log('‚úì JSON extra√≠do por contagem de chaves');
            console.log('JSON limpo (primeiros 200):', jsonStr.substring(0, 200));
            
            const obj = JSON.parse(jsonStr);
            if (obj.marco_logico) return obj;
            if (obj.objetivo_geral && obj.objetivos_especificos) {
              return { marco_logico: obj };
            }
          }
        }
        
        // Estrat√©gia 3: For√ßa bruta - remove caracteres problem√°ticos
        console.log('Tentando for√ßa bruta...');
        
        // Remove todos os caracteres n√£o-ASCII e markdown
        txt = txt.replace(/[^\x20-\x7E\n]/g, ''); // Mant√©m apenas ASCII imprim√≠vel
        txt = txt.replace(/```[^\n]*\n?/g, '');
        txt = txt.replace(/\n+/g, ' ');
        txt = txt.trim();
        
        // Tenta encontrar e extrair JSON novamente
        const braceStart = txt.indexOf('{');
        const braceEnd = txt.lastIndexOf('}');
        
        if (braceStart > -1 && braceEnd > braceStart) {
          const possibleJson = txt.substring(braceStart, braceEnd + 1);
          try {
            const obj = JSON.parse(possibleJson);
            if (obj.marco_logico || (obj.objetivo_geral && obj.objetivos_especificos)) {
              console.log('‚úì JSON extra√≠do por for√ßa bruta');
              return obj.marco_logico ? obj : { marco_logico: obj };
            }
          } catch (e) {
            console.error('For√ßa bruta falhou:', e.message);
          }
        }
        
        throw new Error('Nenhuma estrat√©gia conseguiu extrair o JSON');
        
      } catch (e) {
        console.error('‚ùå Todas as tentativas falharam:', e.message);
        console.error('Resposta completa recebida:', raw);
        
        // √öltima tentativa: pede pro usu√°rio verificar o webhook
        throw new Error('N√£o foi poss√≠vel processar a resposta. Verifique se o webhook est√° configurado para retornar apenas JSON puro, sem markdown ou texto adicional.');
      }
    }

    async function lerPDF(file){
      const buf=await file.arrayBuffer();
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf=await pdfjsLib.getDocument({data:buf}).promise;
      let txt=''; 
      for(let i=1;i<=pdf.numPages;i++){
        const pg=await pdf.getPage(i);
        const c=await pg.getTextContent();
        txt+=c.items.map(it=>it.str).join(' ')+' ';
      } 
      return txt;
    }
    
    async function lerDOCX(file){
      const buf=await file.arrayBuffer();
      const r=await mammoth.extractRawText({arrayBuffer:buf});
      return r.value;
    }

    editalInput.addEventListener('change',async e=>{
      const f=e.target.files[0]; 
      if(!f)return;
      statusEl.textContent='Lendo arquivo...'; 
      statusEl.classList.remove('error','success');
      try{
        if(f.name.endsWith('.txt'))editalConteudo=await f.text();
        else if(f.name.endsWith('.pdf'))editalConteudo=await lerPDF(f);
        else if(f.name.endsWith('.docx'))editalConteudo=await lerDOCX(f);
        else throw new Error('Formato n√£o suportado');
        editalInfo.style.display='block';
        editalInfo.textContent=`${f.name} carregado (${(editalConteudo.length/1024).toFixed(1)} KB)`;
        statusEl.textContent='';
      }catch(err){
        statusEl.textContent='Erro: '+err.message;
        statusEl.classList.add('error');
      }
    });

    document.getElementById('numObjetivos').addEventListener('change',e=>{
      const n=parseInt(e.target.value)||0;
      objetivosContainer.innerHTML='';
      if(n>0){
        objetivosSection.classList.add('ativa');
        for(let i=1;i<=n;i++){
          const div=document.createElement('div');
          div.className='objetivo-input-group';
          div.innerHTML=`
            <h4>Objetivo ${i}</h4>
            <input type="text" name="oe_titulo_${i}" placeholder="T√≠tulo do objetivo ${i}" required>
            <textarea name="oe_descricao_${i}" placeholder="Descri√ß√£o do objetivo ${i}" required></textarea>
          `;
          objetivosContainer.appendChild(div);
        }
      }else{
        objetivosSection.classList.remove('ativa');
      }
    });

    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const nomeProjeto=document.getElementById('nomeProjeto').value.trim();
      const descricaoProposta=document.getElementById('descricaoProposta').value.trim();
      const num=parseInt(document.getElementById('numObjetivos').value);
      
      if(!editalConteudo||!nomeProjeto||!descricaoProposta||!num){
        statusEl.textContent='Preencha todos os campos.';
        statusEl.classList.add('error');
        return;
      }
      
      const objetivosEspecificos=[];
      for(let i=1;i<=num;i++){
        const titulo=form[`oe_titulo_${i}`].value.trim();
        const descricao=form[`oe_descricao_${i}`].value.trim();
        if(!titulo||!descricao){
          statusEl.textContent=`Preencha o Objetivo ${i}`;
          statusEl.classList.add('error');
          return;
        }
        objetivosEspecificos.push({numero:i,titulo,descricao});
      }
      
      const objetivosEspecificosTexto=objetivosToOneLine(objetivosEspecificos);
      const safe={
        edital:sanitizeJSONText(editalConteudo),
        nomeProjeto:sanitizeJSONText(nomeProjeto),
        descricaoProposta:sanitizeJSONText(descricaoProposta),
        objetivosEspecificos,
        objetivosEspecificosTexto
      };

      try{
        submitBtn.disabled=true;
        statusEl.textContent='‚è≥ Enviando para IA...'; 
        statusEl.classList.remove('error','success');

        const r=await fetch('https://hook.us2.make.com/6lkkytmbws4tvlep6aquy1yvt2l0glwm',{
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body:JSON.stringify(safe)
        });
        
        if(!r.ok) throw new Error('Erro HTTP '+r.status);
        
        const txt=await r.text();
        
        console.log('=== DIAGN√ìSTICO COMPLETO ===');
        console.log('Status HTTP:', r.status);
        console.log('Tamanho resposta:', txt.length, 'bytes');
        console.log('Primeiros 50 caracteres:', txt.substring(0, 50));
        console.log('Come√ßa com {?', txt.trim().startsWith('{'));
        console.log('Cont√©m "marco_logico"?', txt.includes('marco_logico'));
        console.log('Cont√©m ```?', txt.includes('```'));
        console.log('=========================');
        
        const marcoLogico=extractMarcoLogico(txt);
        
        console.log('‚úÖ Marco l√≥gico processado com sucesso!');
        statusEl.textContent='‚úÖ Marco L√≥gico gerado, preparando XLSX...'; 
        statusEl.classList.add('success');
        
        gerarXLSX(marcoLogico, nomeProjeto);

      }catch(err){
        console.error('‚ùå Erro:', err);
        statusEl.textContent='‚ùå '+err.message; 
        statusEl.classList.add('error');
        
        // Sugest√£o ao usu√°rio
        if(err.message.includes('webhook')) {
          statusEl.textContent += ' | Use um dos arquivos de configura√ß√£o do webhook fornecidos.';
        }
      }finally{
        submitBtn.disabled=false;
      }
    });

    function gerarXLSX(marco, nomeProjeto){
      const script=document.createElement('script');
      script.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
      script.onload=()=>{
        try{
          const wb=XLSX.utils.book_new();
          const objetivos=marco.marco_logico?.objetivos_especificos||[];
          const totalResultados=objetivos.reduce((a,oe)=>a+(oe.resultados?.length||0),0);
          const totalIndicadores=objetivos.reduce((a,oe)=>a+(oe.resultados||[]).reduce((b,r)=>b+(r.indicadores?.length||0),0),0);
          const totalAtividades=objetivos.reduce((a,oe)=>a+(oe.resultados||[]).reduce((b,r)=>b+(r.atividades?.length||0),0),0);

          const resumo=[
            ['PROJETO',nomeProjeto],
            ['OBJETIVO GERAL',marco.marco_logico?.objetivo_geral||''],
            ['DATA GERA√á√ÉO',new Date().toLocaleDateString('pt-BR')],
            [''],
            ['ESTAT√çSTICAS'],
            ['Objetivos',objetivos.length],
            ['Resultados',totalResultados],
            ['Indicadores',totalIndicadores],
            ['Atividades',totalAtividades]
          ];
          XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(resumo),'Resumo');

          const linhas=[['OE','RESULTADO','INDICADOR','META','ATIVIDADE','L√ìGICA','PRAZO','VERIFICA√á√ÉO']];
          objetivos.forEach(oe=>{
            (oe.resultados||[]).forEach(r=>{
              const inds=r.indicadores||[];
              const atvs=r.atividades||[];
              const n=Math.max(inds.length,atvs.length,1);
              for(let i=0;i<n;i++){
                const ind=inds[i]||{}; 
                const atv=atvs[i]||{};
                linhas.push([
                  oe.titulo||'',
                  r.titulo||'',
                  ind.texto||'',
                  ind.meta||'',
                  atv.descricao||'',
                  atv.logica_intervencao||'',
                  atv.prazo||'',
                  atv.meios_verificacao||''
                ]);
              }
            });
          });
          XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(linhas),'Marco L√≥gico');
          XLSX.writeFile(wb,`Marco_Logico_${nomeProjeto.replace(/\s+/g,'_')}.xlsx`);
          statusEl.textContent='‚úÖ XLSX gerado e baixado com sucesso!'; 
          statusEl.classList.add('success');
        }catch(err){
          statusEl.textContent='‚ùå Erro ao gerar XLSX: '+err.message; 
          statusEl.classList.add('error');
        }
      };
      script.onerror=()=>{
        statusEl.textContent='‚ùå Falha ao carregar biblioteca XLSX';
        statusEl.classList.add('error');
      };
      document.head.appendChild(script);
    }
  </script>
</body>
</html>
