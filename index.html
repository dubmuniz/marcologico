<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Marco Lógico — IA local variada e multilíngue</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    header{text-align:center;padding:16px 0}
    h1{margin:0 0 8px;font-size:26px}
    .lead{color:var(--muted)}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:10px;font:inherit}
    textarea{min-height:110px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 18px;font-weight:600;cursor:pointer;font-size:16px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:10px 0 0;font-size:14px}
    .status.error{color:#c62828}.status.success{color:var(--green)}
    .debug{background:#f7f7f7;border:1px solid #e5e7eb;border-radius:10px;padding:12px;font:12px/1.4 ui-monospace,Consolas,monospace;white-space:pre-wrap;word-break:break-word;max-height:360px;overflow:auto;display:none}
    .table{margin-top:14px;background:#fff;border:1px solid #eee;border-radius:10px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #eee;padding:8px 10px;vertical-align:top;word-break:break-word}
    th{background:#f6fbf6;color:#0f5132;text-align:left;position:sticky;top:0}
    .right{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Marco Lógico</h1>
    <p class="lead">Texto gerado a partir do formulário e do edital, com variação real e multilíngue.</p>
  </header>

  <main class="wrap">
    <form id="frm" novalidate>
      <div class="row3">
        <div>
          <label>Nome do Projeto *</label>
          <input id="nomeProjeto" required placeholder="Ex.: Governança Climática nos Territórios">
        </div>
        <div>
          <label>Qtd. Objetivos Específicos *</label>
          <select id="nOE" required>
            <option value="">Selecione</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div>
          <label>Idioma de saída *</label>
          <select id="lang" required>
            <option value="pt" selected>Português</option>
            <option value="en">English</option>
            <option value="es">Español</option>
          </select>
        </div>
      </div>

      <label>Descrição da Proposta *</label>
      <textarea id="desc" required placeholder="Contexto, público, objetivos, território, metodologia, entregas"></textarea>

      <label>Arquivo do Edital (PDF/DOCX/TXT) — opcional</label>
      <input type="file" id="edital" accept=".pdf,.docx,.doc,.txt">

      <div id="oes"></div>

      <div class="right" style="margin-top:12px">
        <button id="btn">Gerar Marco Lógico</button>
      </div>
      <p id="status" class="status"></p>
    </form>

    <div id="diagBox" class="debug"></div>

    <div id="previewBox" class="table" style="display:none">
      <table id="tbl"><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody></tbody></table>
      <div class="right" style="padding:10px">
        <button id="dlXlsx">Baixar XLSX</button>
      </div>
    </div>
  </main>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

  <script>
    const WEBHOOK_URL = "https://hook.us2.make.com/6lkkytmbws4tvlep6aquy1yvt2l0glwm";

    // UI OEs
    const nOE = document.getElementById('nOE');
    const oesDiv = document.getElementById('oes');
    nOE.addEventListener('change', () => {
      oesDiv.innerHTML = '';
      const n = parseInt(nOE.value||0);
      for (let i=1;i<=n;i++){
        const wrap = document.createElement('div');
        wrap.innerHTML = `
          <div class="row" style="margin-top:10px">
            <div><label>OE ${i}, título *</label>
              <input required id="oe_t_${i}" placeholder="Ex.: Fortalecer governança comunitária">
            </div>
          </div>`;
        oesDiv.appendChild(wrap);
      }
    });

    // Utils
    function utf8Decode(bytes){ try{ return new TextDecoder('utf-8').decode(bytes); }catch{ return String.fromCharCode.apply(null, bytes); } }
    function sliceToJsonEnvelope(txt){ const i=txt.indexOf("{"), j=txt.lastIndexOf("}"); return (i!==-1&&j!==-1&&j>i)?txt.slice(i,j+1):txt; }
    function norm(s){ return (s||"").replace(/\s+/g," ").trim(); }
    function clean(s){ return norm(String(s)).replace(/\u2026|\.{3}/g,""); }
    function joinMV(arr){ return (arr||[]).filter(Boolean).join("; "); }

    // Hash -> PRNG p/ variedade determinística por projeto
    function cyrb128(str){ let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762; for(let i=0;i<str.length;i++){ let k=str.charCodeAt(i); h1=h2^Math.imul(h1^k,597399067); h2=h3^Math.imul(h2^k,2869860233); h3=h4^Math.imul(h3^k,951274213); h4=h1^Math.imul(h4^k,2716044179);} h1=Math.imul(h3^ (h1>>>18),597399067); h2=Math.imul(h4^ (h2>>>22),2869860233); h3=Math.imul(h1^ (h3>>>17),951274213); h4=Math.imul(h2^ (h4>>>19),2716044179); return [(h1^h2^h3^h4)>>>0]; }
    function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15), t|1); t^=t+Math.imul(t^(t>>>7), t|61); return ((t^(t>>>14))>>>0)/4294967296; }; }
    function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }

    // Keywords
    function tokens(text){
      return (text||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9\s-]/g," ").split(/\s+/).filter(Boolean);
    }
    function keyphrases(text, k=10){
      const t=tokens(text); const f=new Map();
      for(let i=0;i<t.length;i++){
        const w=t[i]; if(w.length<4) continue;
        f.set(w,(f.get(w)||0)+1);
        if(i<t.length-1){ const bi=w+" "+t[i+1]; f.set(bi,(f.get(bi)||0)+1); }
      }
      return Array.from(f.entries()).sort((a,b)=>b[1]-a[1]).slice(0,k).map(([w])=>w);
    }

    // Traduções
    const LABEL = {
      pt:{geral:"Objetivo Geral",oe:i=>`Objetivo Específico ${i}`,resultados:"Resultados",indic:"Indicadores",meta:"Meta",mov:"Meios de Verificação",ativ:"Atividades",desc:"Descrição",log:"Lógica de Intervenção",prazo:"Prazo"},
      en:{geral:"Overall Objective",oe:i=>`Specific Objective ${i}`,resultados:"Results",indic:"Indicators",meta:"Target",mov:"Means of Verification",ativ:"Activities",desc:"Description",log:"Intervention Logic",prazo:"Timeline"},
      es:{geral:"Objetivo General",oe:i=>`Objetivo Específico ${i}`,resultados:"Resultados",indic:"Indicadores",meta:"Meta",mov:"Medios de Verificación",ativ:"Actividades",desc:"Descripción",log:"Lógica de Intervención",prazo:"Plazo"}
    };

    // Frases variáveis por idioma
    const TPL = {
      pt:{
        og:(nome,foco,alvo,abordagem)=>`Executar o projeto ${nome} para ${foco}, priorizando ${alvo}, com ${abordagem} e métricas de desempenho alinhadas ao edital.`,
        abord:["abordagem participativa","governança colaborativa","ciclos iterativos de prototipagem","gestão orientada a evidências"],
        alvo:["comunidades locais","beneficiários diretos","parcerias institucionais","redes territoriais"],
        res:(verb,t)=>`${verb} ${t}`,
        verbos:["Consolidar","Ampliar","Qualificar","Estruturar","Integrar","Descentralizar"],
        atvPlan:(base)=>`Planejar ${base} com definição de entregas, responsáveis, cronograma e matriz de riscos.`,
        atvExec:(base)=>`Implementar ${base} em ciclos curtos, monitorar indicadores, coletar feedback e ajustar o plano.`,
        atvCap:(base)=>`Capacitar equipes e lideranças para sustentar ${base} com transferência de conhecimento.`,
        movBase:["Relatórios técnicos","Planilhas de monitoramento","Registros fotográficos"],
        movPart:["Listas de presença","Registros de inscrição","Questionários"],
      },
      en:{
        og:(nome,foco,alvo,abordagem)=>`Deliver the ${nome} project to ${foco}, prioritizing ${alvo}, using ${abordagem} and performance metrics compliant with the call.`,
        abord:["a participatory approach","collaborative governance","iterative prototyping cycles","evidence-driven management"],
        alvo:["local communities","direct beneficiaries","institutional partnerships","territorial networks"],
        res:(verb,t)=>`${verb} ${t}`,
        verbos:["Consolidate","Scale","Improve","Structure","Integrate","Decentralize"],
        atvPlan:(base)=>`Plan ${base} with deliverables, owners, schedule, and risk matrix.`,
        atvExec:(base)=>`Execute ${base} in short cycles, track indicators, collect feedback, and adapt the plan.`,
        atvCap:(base)=>`Train teams and leaders to sustain ${base} with knowledge transfer.`,
        movBase:["Technical reports","Monitoring spreadsheets","Photo records"],
        movPart:["Attendance lists","Registration records","Surveys"],
      },
      es:{
        og:(nome,foco,alvo,abordagem)=>`Ejecutar el proyecto ${nome} para ${foco}, priorizando ${alvo}, con ${abordagem} y métricas de desempeño acordes al llamado.`,
        abord:["enfoque participativo","gobernanza colaborativa","ciclos iterativos de prototipado","gestión basada en evidencias"],
        alvo:["comunidades locales","beneficiarios directos","alianzas institucionales","redes territoriales"],
        res:(verb,t)=>`${verb} ${t}`,
        verbos:["Consolidar","Ampliar","Mejorar","Estructurar","Integrar","Descentralizar"],
        atvPlan:(base)=>`Planificar ${base} con entregables, responsables, cronograma y matriz de riesgos.`,
        atvExec:(base)=>`Ejecutar ${base} en ciclos cortos, monitorear indicadores, recoger retroalimentación y ajustar el plan.`,
        atvCap:(base)=>`Capacitar equipos y liderazgos para sostener ${base} con transferencia de conocimiento.`,
        movBase:["Informes técnicos","Hojas de monitoreo","Registros fotográficos"],
        movPart:["Listas de asistencia","Registros de inscripción","Encuestas"],
      }
    };

    // Indicadores variados
    function indicatorsFor(base, lang, rng, escala=1){
      const L = LABEL[lang];
      const t = TPL[lang];
      const pct = Math.min(95, 70 + Math.floor(rng()*20) + Math.floor(10*escala));
      const num = 80 + Math.floor(rng()*60) + Math.floor(20*escala);
      const qlt = 60 + Math.floor(rng()*25);
      const pool = [
        {texto:(lang==="en"?`Percentage of ${base} achieved`:(lang==="es"?`Porcentaje de ${base} alcanzado`:`Percentual de ${base} alcançado`)), meta:`>= ${pct}%`, meios_verificacao:t.movBase},
        {texto:(lang==="en"?`Number of participants impacted by ${base}`:(lang==="es"?`Número de participantes impactados por ${base}`:`Número de participantes impactados por ${base}`)), meta:`>= ${num}`, meios_verificacao:t.movPart},
        {texto:(lang==="en"?`Satisfaction rate regarding ${base}`:(lang==="es"?`Índice de satisfacción sobre ${base}`:`Índice de satisfação sobre ${base}`)), meta:`>= ${qlt}%`, meios_verificacao:t.movPart}
      ];
      // retorna 2 diferentes
      return [ pool[Math.floor(rng()*pool.length)], pool[Math.floor(rng()*pool.length)] ].map((v,i,arr)=> i===1 && arr[0]===v ? pool[(pool.indexOf(v)+1)%pool.length] : v);
    }

    // Atividades variadas
    function activitiesFor(base, lang, rng){
      const t = TPL[lang];
      const a1 = { titulo:(lang==="en"?`Plan ${base}`:(lang==="es"?`Planificar ${base}`:`Planejar ${base}`)), descricao:t.atvPlan(base), logica_intervencao:(lang==="en"?"Sequence critical activities and align resources":(lang==="es"?"Secuenciar actividades críticas y alinear recursos":"Sequenciar atividades críticas e alinhar recursos")), prazo:"0–3 meses", meios_verificacao:t.movBase };
      const a2 = { titulo:(lang==="en"?`Execute ${base}`:(lang==="es"?`Ejecutar ${base}`:`Executar ${base}`)), descricao:t.atvExec(base), logica_intervencao:(lang==="en"?"Iterate, monitor evidence and adapt":(lang==="es"?"Iterar, monitorear evidencias y adaptar":"Iterar, monitorar evidências e adaptar")), prazo:"3–6 meses", meios_verificacao:t.movBase };
      const a3 = { titulo:(lang==="en"?`Train for ${base}`:(lang==="es"?`Capacitar para ${base}`:`Capacitar para ${base}`)), descricao:t.atvCap(base), logica_intervencao:(lang==="en"?"Build capacities and internal ownership":(lang==="es"?"Desarrollar capacidades y apropiación interna":"Desenvolver capacidades e apropriação interna")), prazo:"6–9 meses", meios_verificacao:t.movPart };
      // escolhe 2 diferentes
      const arr=[a1,a2,a3]; const i1=Math.floor(rng()*arr.length); let i2=Math.floor(rng()*arr.length); if(i2===i1) i2=(i2+1)%arr.length;
      return [arr[i1],arr[i2]];
    }

    // Geração por OE
    function resultsForOE(title, lang, kws, rng){
      const t = TPL[lang];
      const verb1 = pick(rng, t.verbos);
      let verb2 = pick(rng, t.verbos); if(verb2===verb1) verb2=pick(rng, t.verbos);
      const rs = [];
      const bases = [
        title.toLowerCase(),
        (kws[0]||title).toLowerCase()
      ];
      // Resultado 1
      rs.push({
        titulo: t.res(verb1, title),
        indicadores: indicatorsFor(bases[0], lang, rng, 1.0),
        atividades: activitiesFor(bases[0], lang, rng)
      });
      // Resultado 2
      rs.push({
        titulo: t.res(verb2, title),
        indicadores: indicatorsFor(bases[1], lang, rng, 1.2),
        atividades: activitiesFor(bases[1], lang, rng)
      });
      // Terceiro se edital fala de avaliação
      if(kws.join(" ").match(/avali|evalu|evaluat|monitor/i)){
        rs.push({
          titulo: (lang==="en"?`Strengthen monitoring and evaluation for ${title}`:(lang==="es"?`Fortalecer el monitoreo y la evaluación de ${title}`:`Fortalecer monitoramento e avaliação de ${title}`)),
          indicadores: indicatorsFor("monitoramento e avaliação", lang, rng, 0.9),
          atividades: activitiesFor("monitoramento e avaliação", lang, rng)
        });
      }
      return rs;
    }

    // Objetivo geral
    function buildOG(nome, desc, edital, lang, rng){
      const t = TPL[lang];
      const foco = keyphrases(desc+" "+edital, 5).slice(0,3).join(", ");
      const alvo = pick(rng, t.alvo);
      const ab = pick(rng, t.abord);
      return t.og(clean(nome), foco||"resultados prioritários", alvo, ab);
    }

    // IA local principal
    function generateML(nome, desc, oes, edital, lang){
      const seed = cyrb128(nome+"|"+desc+"|"+(oes||[]).map(o=>o.titulo).join("|")+"|"+lang)[0];
      const rng = mulberry32(seed);
      const kws = keyphrases(desc+" "+edital, 20);
      const objetivo_geral = buildOG(nome, desc, edital, lang, rng);
      const objetivos_especificos = (oes||[]).map((oe,idx)=>{
        const titulo = clean(oe.titulo || `OE ${idx+1}`);
        const rs = resultsForOE(titulo, lang, kws, rng);
        return { numero: oe.numero||idx+1, titulo, resultados: rs };
      });
      return { objetivo_geral, objetivos_especificos };
    }

    // Prévia
    function renderPreview(ml, lang){
      const L = LABEL[lang];
      const tb = document.querySelector('#tbl tbody'); tb.innerHTML="";
      const push=(k,v)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td><b>${k}</b></td><td>${v||''}</td>`; tb.appendChild(tr); };

      push(L.geral, ml.objetivo_geral);
      (ml.objetivos_especificos||[]).forEach((oe,idx)=>{
        push(L.oe(oe.numero||idx+1), oe.titulo);
        push("", `<b>${L.resultados}</b>`);
        (oe.resultados||[]).forEach((r)=>{
          push("", `<b>${r.titulo}</b>`);
          push(L.indic, "");
          (r.indicadores||[]).forEach(ind=>{
            push("•", `${ind.texto} | ${L.meta}: ${ind.meta} | ${L.mov}: ${joinMV(ind.meios_verificacao)}`);
          });
        });
        push("", `<b>${L.ativ}</b>`);
        (oe.resultados||[]).forEach(r=>{
          (r.atividades||[]).forEach(a=>{
            push("•", `<b>${a.titulo}</b> — ${a.descricao} | ${L.log}: ${a.logica_intervencao} | ${L.prazo}: ${a.prazo} | ${L.mov}: ${joinMV(a.meios_verificacao)}`);
          });
        });
      });
      document.getElementById('previewBox').style.display='block';
    }

    // XLSX
    function baixarXlsx(ml, nomeProjeto, lang){
      const L = LABEL[lang];
      const wb = XLSX.utils.book_new();
      const aoa=[[ "MARCO LÓGICO" ],[ L.geral, ml.objetivo_geral||"" ]];
      (ml.objetivos_especificos||[]).forEach((oe,idx)=>{
        aoa.push([ L.oe(oe.numero||idx+1), oe.titulo ]);
        aoa.push(["", L.resultados, L.indic, L.meta, L.mov ]);
        (oe.resultados||[]).forEach(r=>{
          const inds=r.indicadores||[];
          for(let i=0;i<inds.length;i++){
            const ind=inds[i];
            aoa.push(["", i===0?r.titulo:"", ind.texto, ind.meta, joinMV(ind.meios_verificacao)]);
          }
        });
        aoa.push(["", L.ativ, L.desc, L.log, L.prazo, L.mov ]);
        (oe.resultados||[]).forEach(r=>{
          (r.atividades||[]).forEach(a=>{
            aoa.push(["", a.titulo, a.descricao, a.logica_intervencao, a.prazo, joinMV(a.meios_verificacao)]);
          });
        });
      });
      const ws=XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols']=[{wch:26},{wch:46},{wch:58},{wch:44},{wch:16},{wch:44}];
      XLSX.utils.book_append_sheet(wb, ws, "Marco Lógico");
      const safe=(nomeProjeto||'Projeto').replace(/[^a-zA-Z0-9]/g,'_').slice(0,30);
      XLSX.writeFile(wb, `Marco_Logico_${safe}_${Date.now()}.xlsx`);
    }

    // Ler edital
    async function readFileText(file){
      if(!file) return "";
      if (file.type === "text/plain") return (await file.text()).slice(0,150000);
      if (file.type === "application/pdf"){
        const buf = new Uint8Array(await file.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({data:buf}).promise;
        const max = Math.min(pdf.numPages, 10);
        let out=""; for(let p=1;p<=max;p++){ const page=await pdf.getPage(p); const txt=await page.getTextContent(); out+=txt.items.map(it=>it.str).join(" ")+"\n"; if(out.length>150000) break; }
        return out.slice(0,150000);
      }
      if (file.name.endsWith(".docx")){
        const ab = await file.arrayBuffer();
        const r = await window.mammoth.extractRawText({arrayBuffer:ab});
        return (r.value||"").slice(0,150000);
      }
      return "";
    }

    // Envio + geração local
    const frm=document.getElementById('frm');
    const statusEl=document.getElementById('status');
    const diagBox=document.getElementById('diagBox');
    const dlBtn=document.getElementById('dlXlsx');
    let lastML=null, lastLang="pt";

    dlBtn.addEventListener('click', ()=>{ if(lastML) baixarXlsx(lastML, document.getElementById('nomeProjeto').value, lastLang); });

    frm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        statusEl.textContent="Processando…";
        statusEl.classList.remove('error','success');
        diagBox.style.display='none'; diagBox.textContent='';

        const lang=document.getElementById('lang').value||"pt"; lastLang=lang;
        const nomeProjeto=clean(document.getElementById('nomeProjeto').value||"");
        const desc=clean(document.getElementById('desc').value||"");
        const n=parseInt(nOE.value||0);
        if(!nomeProjeto||!desc||!n) throw new Error("Preencha nome, descrição e qtd. de objetivos.");

        const objetivosEspecificos=[];
        for(let i=1;i<=n;i++){
          const t=clean(document.getElementById(`oe_t_${i}`).value||"");
          if(!t) throw new Error(`Preencha o título do OE ${i}.`);
          objetivosEspecificos.push({numero:i,titulo:t});
        }

        const file=document.getElementById('edital').files?.[0];
        const editalText=clean(await readFileText(file));

        // chamada ao webhook existente (não dependemos do conteúdo)
        try{
          await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body: JSON.stringify({nomeProjeto,descricaoProposta:desc,objetivosEspecificos,objetivosEspecificosTexto:objetivosEspecificos.map(o=>`${o.numero}. ${o.titulo}`).join(' || '),edital:""})});
        }catch(_){}

        const ml = generateML(nomeProjeto, desc, objetivosEspecificos, editalText, lang);

        lastML=ml;
        renderPreview(ml, lang);
        statusEl.textContent="✓ OK (IA local variada)";
        statusEl.classList.add('success');

        diagBox.style.display='block';
        diagBox.textContent="Diagnóstico: textos gerados a partir de nome, descrição, OEs e edital, com variação determinística.";
      }catch(err){
        statusEl.textContent="Erro: "+err.message;
        statusEl.classList.add('error');
        diagBox.style.display='block';
        diagBox.textContent=(err.stack||String(err));
      }
    });
  </script>
</body>
</html>







