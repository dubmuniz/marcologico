<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Marco Lógico — Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding:20px 0}
    h1{margin:0 0 6px;font-size:26px}
    .lead{color:var(--muted);margin:0 0 12px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .form-section{margin-bottom:18px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{resize:vertical;min-height:110px}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin:8px 0;font-size:13px}
    .objetivos-section{display:none}
    .objetivos-section.ativa{display:block}
    .objetivo-input-group{background:#f9f9f9;border:1px solid #e3e8ee;border-radius:8px;padding:12px;margin:8px 0}
    button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;font-size:16px;width:100%}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:12px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:#1E7E34}
    .debug-info{background:#f5f5f5;border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;font-family:monospace;max-height:400px;overflow-y:auto;display:none;white-space:pre-wrap;word-break:break-all}
    .debug-info.show{display:block}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Marco Lógico</h1>
    <p class="lead">Gerar a partir do edital e da proposta</p>
  </header>

  <main class="wrap">
    <form id="marcoForm" novalidate>
      <div class="form-section">
        <label>Arquivo do edital *
          <input type="file" id="edital" accept=".pdf,.docx,.txt" required>
        </label>
        <div id="editalInfo" class="file-info" style="display:none"></div>
      </div>

      <div class="form-section">
        <label>Nome do Projeto *
          <input id="nomeProjeto" type="text" required placeholder="Ex: Turismo Regenerativo na Ilha do Bananal">
        </label>
      </div>

      <div class="form-section">
        <label>Descrição da proposta *
          <textarea id="descricaoProposta" required placeholder="Contexto, atividades, público e resultados esperados"></textarea>
        </label>
      </div>

      <div class="form-section">
        <label>Quantidade de objetivos específicos *
          <select id="numObjetivos" required>
            <option value="">Selecione</option>
            <option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
          </select>
        </label>
      </div>

      <div class="form-section objetivos-section" id="objetivosSection">
        <div id="objetivosContainer"></div>
      </div>

      <button type="submit" id="submitBtn">Gerar marco lógico</button>
      <p id="status" class="status"></p>
      <div id="debugInfo" class="debug-info"></div>
    </form>
  </main>

  <script>
    // CONFIG
    const WEBHOOK_URL = 'https://hook.us2.make.com/6lkkytmbws4tvlep6aquy1yvt2l0glwm';
    const MAX_EDITAL = 10000, MAX_PROJ = 400, MAX_PROP = 2000, MAX_OBJS = 4000;

    // UI refs
    const form = document.getElementById('marcoForm');
    const editalInput = document.getElementById('edital');
    const editalInfo = document.getElementById('editalInfo');
    const numObjetivosSelect = document.getElementById('numObjetivos');
    const objetivosSection = document.getElementById('objetivosSection');
    const objetivosContainer = document.getElementById('objetivosContainer');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    const debugInfo = document.getElementById('debugInfo');

    // Estado
    let editalConteudo = '';
    let lastPayload = null;

    // Utils
    const sanitizeString = (str) => (str==null?'':String(str).replace(/\uFEFF/g,'').replace(/[\u0000-\u001F\u007F-\u009F]/g,'').replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim());
    const objetivosToOneLine = (arr) => Array.isArray(arr)?arr.map(o=>`${o.numero}. ${sanitizeString(o.titulo).replace(/"/g,'\\"')} | ${sanitizeString(o.descricao).replace(/"/g,'\\"')}`).join(' || '):'';
    const CONTROL_GUIDE = "INSTRUCOES_GERACAO:\n- Nao copiar literalmente trechos do edital ou proposta; usar sinonimos.\n- Objetivo Especifico descreve mudanca de capacidade/comportamento.\n- Resultado descreve produto ou efeito imediato e deve ser diferente do objetivo.\n- Titulos sem as palavras Resultado ou Atividade e sem numeracao; usar verbo no infinitivo + objeto claro.\n- Indicadores SMART com numeros; pelo menos 2 entregaveis nomeados por resultado.\n- Logica de Intervencao com 2 a 3 frases iniciando com maiuscula.\n- Atividades: 2 por resultado, prazos livres em meses.\n";

    // Base64 helpers
    function b64utf8(s){return btoa(unescape(encodeURIComponent(String(s))));}
    function isLikelyB64(s){
      if(!s) return false;
      const t = String(s).trim().replace(/[\r\n\s`"]/g,'');
      return /^[A-Za-z0-9+/_=-]+$/.test(t) && t.length >= 16;
    }
    function normalizeB64(s){
      let t = String(s||'').trim();
      // remove cercas e wrappers comuns
      t = t.replace(/^```(?:json)?/i,'').replace(/```$/,'').trim();
      // se for JSON envelope, tenta extrair campos comuns
      if (t.startsWith('{')) {
        try {
          const j = JSON.parse(t);
          if (j && j.b64) return normalizeB64(j.b64);
          if (j && j.content) return normalizeB64(j.content);
          if (j && j.data) return normalizeB64(j.data);
          if (j && j.marco_logico) return b64utf8(JSON.stringify(j)); // já é JSON final
        } catch(e){}
      }
      // tira aspas soltas e espaços
      t = t.replace(/^[`'"]+|[`'"]+$/g,'').replace(/\s+/g,'');
      // url-safe → padrão
      t = t.replace(/-/g,'+').replace(/_/g,'/');
      // padding
      const pad = t.length % 4; if (pad) t += '='.repeat(4-pad);
      return t;
    }
    function b64ToBytes(b64){
      const clean = normalizeB64(b64);
      try{
        const bin = atob(clean);
        const out = new Uint8Array(bin.length);
        for (let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
        return out;
      }catch(e){
        throw new Error('Base64 inválido após normalização');
      }
    }
    function tryGunzipToText(bytes){
      try{ return new TextDecoder('utf-8').decode(pako.ungzip(bytes)); }
      catch{ return null; }
    }

    // Parser tolerante do provedor
    function parseFromProvider(raw){
      const original = String(raw||'').trim();
      // 1) Se já veio JSON direto com marco_logico
      if (original.startsWith('{')) {
        try{
          const j = JSON.parse(original);
          if (j && j.marco_logico) return j;
          if (j && typeof j.b64 === 'string') {
            const bytes = b64ToBytes(j.b64);
            const gun = tryGunzipToText(bytes);
            if (gun) return JSON.parse(gun);
            const asText = new TextDecoder('utf-8').decode(bytes);
            return JSON.parse(asText);
          }
        }catch(e){/* continua */}
      }

      // 2) Tratar como Base64 “de alguma forma”
      let b64 = normalizeB64(original);
      if (!isLikelyB64(b64)) {
        // última tentativa: remover tudo que não é base64 e tentar
        b64 = original.replace(/[^A-Za-z0-9+/_=-]/g,'');
      }
      const bytes = b64ToBytes(b64);
      // tenta gunzip
      const gun = tryGunzipToText(bytes);
      let text = gun;
      if (!text) {
        // pode ser apenas JSON plano em Base64
        text = new TextDecoder('utf-8').decode(bytes);
      }
      // sanitiza texto JSON
      let clean = String(text||'')
        .replace(/\uFEFF/g,'')
        .replace(/[\u0000-\u001F\u007F]/g,' ')
        .replace(/\s+\}/g,'}')
        .replace(/\s+\]/g,']')
        .trim();

      // corta sobras fora do objeto principal
      const start = clean.indexOf('{"marco_logico"');
      if (start > 0) clean = clean.slice(start);
      // tenta parser direto
      try { return JSON.parse(clean); } catch(e1){}
      // remove vírgulas antes de ']' ou '}'
      try { return JSON.parse(clean.replace(/,(\s*[}\]])/g,'$1')); } catch(e2){}
      // erro final com diagnóstico útil
      const snippet = clean.slice(0,200);
      const err = new Error('Falha ao interpretar JSON da IA');
      err._snippet = snippet;
      throw err;
    }

    // Normalizador mínimo (mantido do seu fluxo)
    function normalizeMarco(data, payload){
      const ml = data?.marco_logico || {};
      const objetivoGeral = sanitizeString(ml.objetivo_geral || payload?.descricaoProposta || payload?.nomeProjeto || 'nao informado');
      const solicitados = Array.isArray(payload?.objetivosEspecificos) ? payload.objetivosEspecificos.length : 0;
      const baseObjs = Array.isArray(ml.objetivos_especificos) ? ml.objetivos_especificos : [];

      while(baseObjs.length < solicitados){
        const i = baseObjs.length;
        const src = payload.objetivosEspecificos[i];
        baseObjs.push({ numero: i+1, titulo: sanitizeString(src?.titulo||(`Objetivo ${i+1}`)), descricao: sanitizeString(src?.descricao||('')), resultados: [], atividades: [] });
      }

      const objetivos = baseObjs.slice(0, Math.max(solicitados, baseObjs.length)).map((obj, idx)=>{
        const titulo = sanitizeString(obj.titulo||payload?.objetivosEspecificos?.[idx]?.titulo||`Objetivo ${idx+1}`);
        const desc = sanitizeString(obj.descricao||payload?.objetivosEspecificos?.[idx]?.descricao||'');
        let resultados = Array.isArray(obj.resultados)?obj.resultados:[];
        if(resultados.length===0){
          resultados = [1,2].map(rn=>({
            titulo: `Entregar componente ${idx+1}.${rn}`,
            indicadores: [
              { texto:`Manual do componente publicado`, meta:`1 manual ate M6`, meios_verificacao:[`link do manual`] },
              { texto:`3 oficinas realizadas`, meta:`3 oficinas ate M12`, meios_verificacao:[`listas de presenca`] },
              { texto:`Satisfacao media >= ${82+rn}%`, meta:`>= ${82+rn}% ate M12`, meios_verificacao:[`pesquisa de satisfacao`] }
            ],
            meios_verificacao:[`relatorios e planilhas`],
            atividades: [
              { titulo:`Planejar ${titulo}`, descricao:`Definir escopo, recursos e riscos`, logica_intervencao:`Planejamento claro reduz riscos e retrabalho. Priorizacao orienta alocacao de recursos.`, prazo:`M1-3` },
              { titulo:`Executar piloto`, descricao:`Validar solucao com grupo reduzido`, logica_intervencao:`Iteracoes curtas aceleram aprendizado. Evidencias facilitam ajustes.`, prazo:`M3-6` }
            ]
          }));
        }
        return { numero: obj.numero||idx+1, titulo, descricao:desc, resultados, atividades: obj.atividades||[] };
      });

      return { marco_logico: { objetivo_geral: objetivoGeral, objetivos_especificos: objetivos} };
    }

    // Estilo e enriquecimento (mantidos)
    function cleanTitle(t){
      if(!t) return '';
      let s = String(t).trim();
      s = s.replace(/^\s*\d+(?:\.\d+)*\s*[:\-–]\s*/,'');
      s = s.replace(/\b(Resultado|Atividade|Objetivo)\b.*?:?\s*/ig,'');
      s = s.replace(/\s{2,}/g,' ').trim();
      return s || 'Definir entregavel prioritario';
    }
    function sentenceCasePara(p){
      return String(p||'').split('.').map(s => {
        const x = s.trim();
        if(!x) return '';
        return x.charAt(0).toUpperCase() + x.slice(1);
      }).filter(Boolean).join('. ') + (p && !/[.!?]\s*$/.test(p)?'.':'');
    }
    function synthDeliverables(resTitle){
      const base = cleanTitle(resTitle).toLowerCase();
      return [
        {texto:`Manual de ${base} publicado`, meta:`1 manual ate M6`, mov:[`link do manual`]},
        {texto:`Plataforma v1 de ${base} lancada`, meta:`v1 ativa ate M12`, mov:[`URL da plataforma`]},
        {texto:`3 oficinas sobre ${base} realizadas`, meta:`3 oficinas ate M12`, mov:[`listas de presenca`]}
      ];
    }
    function enrichIndicators(res){
      let inds = Array.isArray(res.indicadores)? res.indicadores : [];
      inds = inds.filter(i => i && (i.texto||'').trim());
      const dlv = synthDeliverables(res.titulo||'resultado');
      for(const d of dlv){
        if(inds.length>=2) break;
        inds.push({texto:d.texto, meta:d.meta, meios_verificacao:d.mov});
      }
      while(inds.length<3){
        const k = inds.length+1;
        inds.push({
          texto: `Satisfacao media >= ${80 + k}% do publico-alvo`,
          meta:  `>= ${80 + k}% ate M12`,
          meios_verificacao: [`pesquisa de satisfacao`]
        });
      }
      res.indicadores = inds.map(i=>({
        texto: cleanTitle(i.texto),
        meta:  String(i.meta||'nao informado'),
        meios_verificacao: Array.isArray(i.meios_verificacao)&&i.meios_verificacao.length? i.meios_verificacao.map(String): ['nao informado']
      }));
    }
    function enrichActivities(res){
      let acts = Array.isArray(res.atividades)? res.atividades : [];
      acts = acts.filter(a=>a && (a.titulo||a.descricao));
      const needed = Math.max(0, 2 - acts.length);
      const seeds = [
        {titulo:`Planejar ${cleanTitle(res.titulo)}`, prazo:'M1-3'},
        {titulo:`Executar piloto de ${cleanTitle(res.titulo)}`, prazo:'M3-6'},
        {titulo:`Documentar e publicar ${cleanTitle(res.titulo)}`, prazo:'M6-12'}
      ];
      for(let i=0;i<needed;i++){
        const s = seeds[i%seeds.length];
        acts.push({
          titulo: s.titulo,
          descricao: `Definir escopo, recursos e responsabilidades.`,
          logica_intervencao: `Planejamento claro reduz riscos e retrabalho. Foco em iteracoes curtas acelera aprendizado. Evidencias publicadas facilitam reproducao e monitoramento.`,
          prazo: s.prazo
        });
      }
      res.atividades = acts.slice(0,2).map(a=>({
        titulo: cleanTitle(a.titulo),
        descricao: cleanTitle(a.descricao||''),
        logica_intervencao: sentenceCasePara(a.logica_intervencao || `A intervencao gera valor ao alinhar escopo e recursos. Evidencias permitem ajuste continuo.`),
        prazo: String(a.prazo||'M1-3')
      }));
    }
    function separateObjectiveFromResults(obj){
      const objCore = (obj.titulo||'').toLowerCase().slice(0,60);
      (obj.resultados||[]).forEach(r=>{
        let t = cleanTitle(r.titulo||'');
        if(t.toLowerCase().includes(objCore)){
          t = t.replace(new RegExp(objCore,'i'),'').trim();
        }
        r.titulo = t || 'Entregar produto e efeito imediato';
      });
    }
    function enforceStyle(model){
      const ml = model && model.marco_logico ? model.marco_logico : {objetivos_especificos:[]};
      ml.objetivo_geral = sentenceCasePara(ml.objetivo_geral || 'nao informado');
      (ml.objetivos_especificos||[]).forEach((obj)=>{
        obj.titulo = cleanTitle(obj.titulo||'');
        obj.descricao = cleanTitle(obj.descricao||'');
        separateObjectiveFromResults(obj);
        (obj.resultados||[]).forEach((r)=>{
          r.titulo = cleanTitle(r.titulo||'');
          enrichIndicators(r);
          enrichActivities(r);
          if(!Array.isArray(r.meios_verificacao) || r.meios_verificacao.length===0){
            r.meios_verificacao = ['relatorios e evidencias publicadas'];
          }
        });
      });
      model.marco_logico = ml;
      return model;
    }

    // XLSX
    function gerarXLSX(responseData, nomeProjeto) {
      const marco = responseData.marco_logico || {};
      const objetivos = Array.isArray(marco.objetivos_especificos) ? marco.objetivos_especificos : [];
      const wb = XLSX.utils.book_new();

      const aoa = [];
      const merges = [];
      const T = (v) => (v==null ? '' : String(v)).replace(/\uFEFF/g,'').replace(/[\u0000-\u001F\u007F-\u009F]/g,'').trim();
      const J = (arr) => Array.isArray(arr) ? arr.map((x)=>T(x.texto||x.descricao||x)).filter(Boolean).join('; ') : T(arr);

      aoa.push(['MARCO LÓGICO']); merges.push({s:{r:0,c:0},e:{r:0,c:7}});
      aoa.push(['Objetivo Geral', T(marco.objetivo_geral||'')]); merges.push({s:{r:1,c:1},e:{r:1,c:7}});

      objetivos.forEach((obj, idx) => {
        aoa.push([`Objetivo Específico ${obj.numero||idx+1}`, T(obj.titulo||obj.descricao||'')]);
        merges.push({s:{r:aoa.length-1,c:1},e:{r:aoa.length-1,c:7}});

        const startRIndex = aoa.length;
        aoa.push(['RESULTADOS OBJETIVO '+(obj.numero||idx+1), 'Indicadores', 'Meta', 'Meios de Verificação', '', '', '', '']);

        const resultados = Array.isArray(obj.resultados) ? obj.resultados : [];
        let linhas = 0;

        resultados.forEach((res) => {
          const inds = Array.isArray(res.indicadores) ? res.indicadores : [];
          const movs = Array.isArray(res.meios_verificacao) ? res.meios_verificacao : [];
          const max = Math.max(1, inds.length, movs.length);
          for (let i = 0; i < max; i++) {
            const ind = inds[i] || {};
            aoa.push([
              i===0 ? T(res.titulo||res.descricao||'') : '',
              T(ind.texto||''),
              T(ind.meta||''),
              J(ind.meios_verificacao?.length ? ind.meios_verificacao : movs),
              '', '', '', ''
            ]);
            linhas++;
          }
        });

        if (linhas === 0) { aoa.push(['Sem resultados definidos', '', '', '', '', '', '', '']); linhas = 1; }

        aoa.push(['', 'Atividades', 'Lógica de Intervenção', 'Prazo', '', '', '', '']);
        const atividades = resultados.flatMap(r=>Array.isArray(r.atividades)?r.atividades:[]);
        if (atividades.length === 0) {
          aoa.push(['', 'Sem atividades definidas', '', '', '', '', '', '']);
        } else {
          atividades.forEach((atv) => {
            aoa.push(['', T(atv.titulo||atv.descricao||''), T(atv.logica_intervencao||atv.logica||''), T(atv.prazo||''), '', '', '', '']);
          });
        }
      });

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols'] = [{ wch: 36 }, { wch: 42 }, { wch: 22 }, { wch: 38 }, { wch: 4 }, { wch: 4 }, { wch: 4 }, { wch: 4 }];
      ws['!merges'] = merges;
      // wrap
      const range = XLSX.utils.decode_range(ws['!ref']);
      for(let R=range.s.r; R<=range.e.r; R++){
        for(let C=range.s.c; C<=range.e.c; C++){
          const addr = XLSX.utils.encode_cell({r:R,c:C});
          if(!ws[addr]) continue;
          ws[addr].s = {alignment:{wrapText:true,vertical:'top'}};
        }
      }
      XLSX.utils.book_append_sheet(wb, ws, 'Marco Lógico');

      const wsR = XLSX.utils.aoa_to_sheet([
        ['MARCO LÓGICO - RESUMO'], [''],
        ['Nome do Projeto', String(nomeProjeto||'')],
        ['Objetivo Geral', T(marco.objetivo_geral||'')],
        ['Data', new Date().toLocaleDateString('pt-BR')]
      ]);
      wsR['!cols'] = [{ wch: 20 }, { wch: 70 }];
      XLSX.utils.book_append_sheet(wb, wsR, 'Resumo');

      const ts = Date.now();
      const nomeSeguro = (nomeProjeto||'Projeto').replace(/[^a-zA-Z0-9]/g,'_').substring(0,30);
      XLSX.writeFile(wb, `Marco_Logico_${nomeSeguro}_${ts}.xlsx`);
    }

    // Leitura arquivos
    async function lerPDF(file){
      const buf = await file.arrayBuffer();
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      let texto=''; for(let p=1;p<=pdf.numPages;p++){ const page=await pdf.getPage(p); const tc=await page.getTextContent(); texto += tc.items.map(i=>i.str).join(' ')+' '; }
      return sanitizeString(texto);
    }
    async function lerDOCX(file){
      const buf = await file.arrayBuffer(); const res = await mammoth.extractRawText({arrayBuffer:buf}); return sanitizeString(res.value);
    }

    // Eventos
    editalInput.addEventListener('change', async (e)=>{
      const file=e.target.files[0]; if(!file) return;
      statusEl.textContent='Lendo arquivo...'; statusEl.classList.remove('error','success'); debugInfo.classList.remove('show');
      try{
        const name=file.name.toLowerCase();
        if(name.endsWith('.txt')||file.type==='text/plain'){editalConteudo=await file.text();}
        else if(name.endsWith('.pdf')||file.type==='application/pdf'){editalConteudo=await lerPDF(file);}
        else if(name.endsWith('.docx')||name.endsWith('.doc')){editalConteudo=await lerDOCX(file);}
        else{throw new Error('Formato não suportado. Use PDF, DOCX ou TXT.');}
        editalConteudo=sanitizeString(editalConteudo);
        if(editalConteudo.length>MAX_EDITAL){editalConteudo=editalConteudo.slice(0,MAX_EDITAL)+'... [truncado]';}
        if(!editalConteudo||editalConteudo.length<10) throw new Error('Arquivo vazio ou com conteúdo insuficiente');
        editalInfo.style.display='block'; editalInfo.textContent=`✓ ${file.name} carregado`;
        statusEl.textContent='';
      }catch(err){ statusEl.textContent='Erro ao ler arquivo: '+err.message; statusEl.classList.add('error'); editalInfo.style.display='none'; editalConteudo='';}
    });

    numObjetivosSelect.addEventListener('change',(e)=>{
      const n=parseInt(e.target.value)||0;
      objetivosContainer.innerHTML='';
      if(n>0){
        objetivosSection.classList.add('ativa');
        for(let i=1;i<=n;i++){
          const div=document.createElement('div'); div.className='objetivo-input-group';
          div.innerHTML=`<strong>Objetivo Específico ${i}</strong>
            <input type="text" name="oe_titulo_${i}" placeholder="Título do objetivo ${i}" required>
            <textarea name="oe_descricao_${i}" placeholder="Descrição detalhada do objetivo ${i}" required></textarea>`;
          objetivosContainer.appendChild(div);
        }
      } else objetivosSection.classList.remove('ativa');
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      debugInfo.classList.remove('show'); debugInfo.innerHTML=''; statusEl.classList.remove('error','success');
      if(!editalConteudo){ statusEl.textContent='Por favor, carregue o arquivo do edital'; statusEl.classList.add('error'); return; }

      const nomeProjeto=sanitizeString(document.getElementById('nomeProjeto').value);
      const descricaoProposta=sanitizeString(document.getElementById('descricaoProposta').value);
      const n=parseInt(numObjetivosSelect.value)||0;
      if(!nomeProjeto||!descricaoProposta||!n){ statusEl.textContent='Por favor, preencha todos os campos obrigatórios'; statusEl.classList.add('error'); return; }

      const objetivosEspecificos=[];
      for(let i=1;i<=n;i++){
        const t=sanitizeString(form[`oe_titulo_${i}`].value);
        const d=sanitizeString(form[`oe_descricao_${i}`].value);
        if(!t||!d){ statusEl.textContent=`Por favor, preencha completamente o objetivo ${i}`; statusEl.classList.add('error'); return; }
        objetivosEspecificos.push({numero:i,titulo:t.substring(0,200),descricao:d.substring(0,500)});
      }

      // Guia oculto injeta preferências sem tocar no body do Claude
      const editalForModel   = (CONTROL_GUIDE + "\nEDITAL:\n"   + editalConteudo).slice(0, MAX_EDITAL);
      const projetoForModel  = (CONTROL_GUIDE + "\nPROJETO:\n"  + nomeProjeto).slice(0, MAX_PROJ);
      const propostaForModel = (CONTROL_GUIDE + "\nPROPOSTA:\n" + descricaoProposta).slice(0, MAX_PROP);
      const objsTxtForModel  = (CONTROL_GUIDE + "\nOBJ_TXT:\n"  + objetivosToOneLine(objetivosEspecificos)).slice(0, MAX_OBJS);

      const payload={
        edital_b64: b64utf8(editalForModel),
        nomeProjeto_b64: b64utf8(projetoForModel),
        descricaoProposta_b64: b64utf8(propostaForModel),
        objetivosEspecificosTexto_b64: b64utf8(objsTxtForModel),
        nomeProjeto, descricaoProposta, objetivosEspecificos,
        objetivosEspecificosTexto: objetivosToOneLine(objetivosEspecificos),
        filled_at: new Date().toISOString().slice(0,10),
        type: 'marco_logico'
      };
      lastPayload = payload;

      try{
        submitBtn.disabled=true;
        statusEl.textContent='Enviando dados para processamento...';

        const resp=await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json, text/plain'},body:JSON.stringify(payload)});
        const respText = await resp.text();
        if(!resp.ok){ throw new Error(`Erro HTTP: ${resp.status} ${resp.statusText} | ${respText.slice(0,600)}`); }

        statusEl.textContent='Interpretando resposta da IA...';
        let parsed;
        try{
          parsed = parseFromProvider(respText);
        }catch(e){
          statusEl.classList.add('error');
          debugInfo.textContent = 'Diagnóstico do parser:\n' +
            (e.message||'') + '\n' +
            (e._snippet?('Prévia normalizada: ' + e._snippet):'');
          debugInfo.classList.add('show');
          throw e;
        }

        const normalized = normalizeMarco(parsed, lastPayload);
        const styled = enforceStyle(normalized);

        statusEl.textContent='Gerando arquivo Excel...';
        gerarXLSX(styled, nomeProjeto);

        statusEl.textContent='✓ Marco Lógico gerado com sucesso!';
        statusEl.classList.add('success');
      }catch(err){
        if(!statusEl.classList.contains('error')){
          statusEl.textContent=`Erro: ${err.message}`;
          statusEl.classList.add('error');
        }
        if(!debugInfo.classList.contains('show')){
          debugInfo.textContent = (err && err.stack) ? err.stack : String(err);
          debugInfo.classList.add('show');
        }
      }finally{
        submitBtn.disabled=false;
      }
    });
  </script>
</body>
</html>





