<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Marco Lógico — Humana Brasil</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--green:#1E7E34;--ink:#1b1b1b;--bg:#fafafa;--muted:#667085}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{text-align:center;padding:20px 0}
    h1{margin:0 0 6px;font-size:26px}
    .lead{color:var(--muted);margin:0 0 12px}
    form{background:#fff;border:1px solid #eee;border-radius:12px;padding:22px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .form-section{margin-bottom:18px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,textarea,select{width:100%;border:1px solid #d8dee4;border-radius:8px;padding:12px;font:inherit}
    textarea{resize:vertical;min-height:110px}
    .file-info{background:#f0f7f4;border-left:4px solid var(--green);padding:10px;border-radius:6px;margin:8px 0;font-size:13px}
    .objetivos-section{display:none}
    .objetivos-section.ativa{display:block}
    .objetivo-input-group{background:#f9f9f9;border:1px solid #e3e8ee;border-radius:8px;padding:12px;margin:8px 0}
    button{background:var(--green);color:#fff;border:0;border-radius:10px;padding:12px 20px;font-weight:600;cursor:pointer;font-size:16px;width:100%}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{min-height:22px;color:var(--muted);margin:12px 0 0;font-size:14px}
    .status.error{color:#d32f2f}
    .status.success{color:#1E7E34}
    .status.warning{color:#ff9800}
    .debug-info{background:#f5f5f5;border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;font-size:12px;font-family:monospace;max-height:400px;overflow-y:auto;display:none;white-space:pre-wrap;word-break:break-all}
    .debug-info.show{display:block}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Marco Lógico</h1>
    <p class="lead">Gerar a partir do edital e da proposta</p>
  </header>

  <main class="wrap">
    <form id="marcoForm" novalidate>
      <div class="form-section">
        <label>Arquivo do edital *
          <input type="file" id="edital" accept=".pdf,.docx,.txt" required>
        </label>
        <div id="editalInfo" class="file-info" style="display:none"></div>
      </div>

      <div class="form-section">
        <label>Nome do Projeto *
          <input id="nomeProjeto" type="text" required placeholder="Ex: Turismo Regenerativo na Ilha do Bananal">
        </label>
      </div>

      <div class="form-section">
        <label>Descrição da proposta *
          <textarea id="descricaoProposta" required placeholder="Contexto, atividades, público e resultados esperados"></textarea>
        </label>
      </div>

      <div class="form-section">
        <label>Quantidade de objetivos específicos *
          <select id="numObjetivos" required>
            <option value="">Selecione</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </label>
      </div>

      <div class="form-section objetivos-section" id="objetivosSection">
        <div id="objetivosContainer"></div>
      </div>

      <button type="submit" id="submitBtn">Gerar marco lógico</button>
      <p id="status" class="status"></p>
      <div id="debugInfo" class="debug-info"></div>
    </form>
  </main>

  <script>
    const WEBHOOK_URL = 'https://hook.us2.make.com/6lkkytmbws4tvlep6aquy1yvt2l0glwm';

    const form = document.getElementById('marcoForm');
    const editalInput = document.getElementById('edital');
    const editalInfo = document.getElementById('editalInfo');
    const numObjetivosSelect = document.getElementById('numObjetivos');
    const objetivosSection = document.getElementById('objetivosSection');
    const objetivosContainer = document.getElementById('objetivosContainer');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    const debugInfo = document.getElementById('debugInfo');

    let editalConteudo = '';

    function sanitizeString(str){
      if(str==null) return '';
      return String(str).replace(/\uFEFF/g,'').replace(/[\u0000-\u001F\u007F-\u009F]/g,'').replace(/\r?\n/g,' ').replace(/\s+/g,' ').trim();
    }
    function objetivosToOneLine(arr){
      if(!Array.isArray(arr)) return '';
      return arr.map(o=>{
        const t=sanitizeString(o.titulo).replace(/"/g,'\\"');
        const d=sanitizeString(o.descricao).replace(/"/g,'\\"');
        return `${o.numero}. ${t} | ${d}`;
      }).join(' || ');
    }

    function reconstructTruncatedJSON(jsonStr){
      jsonStr=jsonStr.replace(/^```json\s*/i,'').replace(/```\s*$/,'').trim();
      const last=jsonStr.slice(-20);
      const broken = jsonStr.split('{').length!==jsonStr.split('}').length;
      if(broken){
        let cut=jsonStr.lastIndexOf('}');
        if(cut<0) cut=jsonStr.lastIndexOf(']');
        if(cut>0) jsonStr=jsonStr.slice(0,cut+1);
        const opensB=(jsonStr.match(/\[/g)||[]).length, closesB=(jsonStr.match(/]/g)||[]).length;
        const opensC=(jsonStr.match(/{/g)||[]).length, closesC=(jsonStr.match(/}/g)||[]).length;
        for(let i=0;i<opensB-closesB;i++) jsonStr+=']';
        for(let i=0;i<opensC-closesC;i++) jsonStr+='}';
      }
      return jsonStr;
    }

    function parseMarcoResponse(raw){
      try{
        let s = reconstructTruncatedJSON(raw)
          .replace(/\uFEFF/g,'')
          .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g,'');
        let start = s.indexOf('{"marco_logico"');
        if(start>0) s=s.slice(start);
        try{ return JSON.parse(s);}catch(_){}
        const cleaned=s.replace(/\n/g,' ').replace(/\s+/g,' ');
        try{ return JSON.parse(cleaned);}catch(_){}
        const evalStr = cleaned.replace(/undefined/g,'null').replace(/(\w+):/g,'" $1":');
        return Function('"use strict";return('+evalStr+')')();
      }catch(e){
        debugInfo.innerHTML = 'Falha ao interpretar JSON retornado.';
        debugInfo.classList.add('show');
        throw new Error('JSON inválido ou truncado');
      }
    }

    async function lerPDF(file){
      const buf = await file.arrayBuffer();
      pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      let texto='';
      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const tc = await page.getTextContent();
        texto += tc.items.map(i=>i.str).join(' ')+' ';
      }
      return sanitizeString(texto);
    }
    async function lerDOCX(file){
      const buf = await file.arrayBuffer();
      const res = await mammoth.extractRawText({arrayBuffer:buf});
      return sanitizeString(res.value);
    }

    editalInput.addEventListener('change', async (e)=>{
      const file=e.target.files[0];
      if(!file) return;
      statusEl.textContent='Lendo arquivo...';
      statusEl.classList.remove('error','success','warning');
      debugInfo.classList.remove('show');
      try{
        const name=file.name.toLowerCase();
        if(name.endsWith('.txt')||file.type==='text/plain'){editalConteudo=await file.text();}
        else if(name.endsWith('.pdf')||file.type==='application/pdf'){editalConteudo=await lerPDF(file);}
        else if(name.endsWith('.docx')||name.endsWith('.doc')){editalConteudo=await lerDOCX(file);}
        else{throw new Error('Formato não suportado. Use PDF, DOCX ou TXT.');}
        editalConteudo=sanitizeString(editalConteudo);
        const MAX=50000;
        if(editalConteudo.length>MAX){editalConteudo=editalConteudo.slice(0,MAX)+'... [truncado]';}
        if(!editalConteudo||editalConteudo.length<10) throw new Error('Arquivo vazio ou ilegível');
        editalInfo.style.display='block';
        editalInfo.textContent=`✓ ${file.name} carregado (${(editalConteudo.length/1024).toFixed(1)} KB)`;
        statusEl.textContent='';
      }catch(err){
        statusEl.textContent='Erro ao ler arquivo: '+err.message;
        statusEl.classList.add('error');
        editalInfo.style.display='none';
        editalConteudo='';
      }
    });

    numObjetivosSelect.addEventListener('change',(e)=>{
      const n=parseInt(e.target.value)||0;
      objetivosContainer.innerHTML='';
      if(n>0){
        objetivosSection.classList.add('ativa');
        for(let i=1;i<=n;i++){
          const div=document.createElement('div');
          div.className='objetivo-input-group';
          div.innerHTML=`
            <strong>Objetivo Específico ${i}</strong>
            <input type="text" name="oe_titulo_${i}" placeholder="Título do objetivo ${i}" required>
            <textarea name="oe_descricao_${i}" placeholder="Descrição detalhada do objetivo ${i}" required></textarea>
          `;
          objetivosContainer.appendChild(div);
        }
      }else{
        objetivosSection.classList.remove('ativa');
      }
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      debugInfo.classList.remove('show'); debugInfo.innerHTML='';
      statusEl.classList.remove('warning');
      if(!editalConteudo){statusEl.textContent='Carregue o arquivo do edital';statusEl.classList.add('error');return;}
      const nomeProjeto=sanitizeString(document.getElementById('nomeProjeto').value);
      const descricaoProposta=sanitizeString(document.getElementById('descricaoProposta').value);
      const n=parseInt(numObjetivosSelect.value)||0;
      if(!nomeProjeto||!descricaoProposta||!n){statusEl.textContent='Preencha todos os campos';statusEl.classList.add('error');return;}
      const objetivosEspecificos=[];
      for(let i=1;i<=n;i++){
        const t=sanitizeString(form[`oe_titulo_${i}`].value);
        const d=sanitizeString(form[`oe_descricao_${i}`].value);
        if(!t||!d){statusEl.textContent=`Preencha o objetivo ${i}`;statusEl.classList.add('error');return;}
        objetivosEspecificos.push({numero:i,titulo:t.substring(0,200),descricao:d.substring(0,500)});
      }
      const payload={
        edital:editalConteudo,
        nomeProjeto:nomeProjeto,
        descricaoProposta:descricaoProposta.substring(0,1000),
        objetivosEspecificos:objetivosEspecificos,
        objetivosEspecificosTexto:objetivosToOneLine(objetivosEspecificos)
      };
      try{
        submitBtn.disabled=true;
        statusEl.textContent='Enviando dados para processamento...';
        statusEl.classList.remove('error','success');
        const resp=await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json, text/plain'},body:JSON.stringify(payload)});
        if(!resp.ok) throw new Error(`Erro HTTP: ${resp.status} ${resp.statusText}`);
        statusEl.textContent='Processando resposta da IA...';
        const txt=await resp.text();
        const parsed=parseMarcoResponse(txt);
        statusEl.textContent='Gerando arquivo Excel...';
        gerarXLSX(parsed,nomeProjeto);
        statusEl.textContent='✓ Marco Lógico gerado com sucesso';
        statusEl.classList.add('success');
      }catch(err){
        statusEl.textContent=`Erro: ${err.message}`;
        statusEl.classList.add('error');
        if(!debugInfo.classList.contains('show')){
          debugInfo.textContent='Detalhe: '+err.stack;
          debugInfo.classList.add('show');
        }
      }finally{
        submitBtn.disabled=false;
      }
    });

    // -------- XLSX no formato do exemplo --------
    function gerarXLSX(responseData,nomeProjeto){
      const marco = responseData?.marco_logico||{};
      const objetivos = Array.isArray(marco.objetivos_especificos)?marco.objetivos_especificos:[];
      const wb=XLSX.utils.book_new();

      // Planilha "Marco Lógico" no layout do anexo
      const aoa=[];
      const merges=[];

      // Helpers
      const pushRow = (row)=>{ aoa.push(row); return aoa.length-1; };
      const txt = (v)=>sanitizeString(v||'');

      // Cabeçalho
      pushRow(['Marco Lógico']);                             // A1
      merges.push({s:{r:0,c:0},e:{r:0,c:7}});
      pushRow(['Objetivo Geral', txt(marco.objetivo_geral||'')]); // A2 B2..H2
      merges.push({s:{r:1,c:1},e:{r:1,c:7}});

      // Para cada Objetivo Específico
      objetivos.forEach((obj,idx)=>{
        // Linha do Objetivo Específico
        const lbl = `Objetivo Específico ${obj.numero||idx+1}`;
        pushRow([lbl, txt(obj.titulo||obj.descricao||'')]);
        merges.push({s:{r:aoa.length-1,c:1},e:{r:aoa.length-1,c:7}});

        // Bloco RESULTADOS
        // Título da seção na col A, com merge vertical calculado
        const startResultadosIndex = aoa.length;
        // Subcabeçalho de Resultados
        pushRow(['', 'Resultados', 'Indicadores', 'Meios de Verificação','','','','']);
        merges.push({s:{r:aoa.length-1,c:1},e:{r:aoa.length-1,c:1}});
        merges.push({s:{r:aoa.length-1,c:2},e:{r:aoa.length-1,c:2}});
        merges.push({s:{r:aoa.length-1,c:3},e:{r:aoa.length-1,c:3}});

        const resultados = Array.isArray(obj.resultados)?obj.resultados:[];
        let linhasResultados = 0;

        if(resultados.length===0){
          pushRow(['', 'Sem resultados definidos','','','','','','']);
          linhasResultados=1;
        }else{
          resultados.forEach((res)=>{
            const inds = Array.isArray(res.indicadores)?res.indicadores:[];
            const mvs  = Array.isArray(res.meios_verificacao)?res.meios_verificacao:[];
            const max = Math.max(1,inds.length,mvs.length);
            for(let i=0;i<max;i++){
              const ind = inds[i]||{};
              const mv  = mvs[i]||{};
              pushRow([
                '', // reservado para merge de "RESULTADOS OBJETIVO i"
                i===0?txt(res.titulo||res.descricao||''):'',
                txt(ind.texto||ind.descricao||''),
                txt(mv.texto||mv.descricao||''),
                '','','',''
              ]);
              linhasResultados++;
            }
          });
        }
        // Merge vertical do rótulo "RESULTADOS OBJETIVO X"
        const rotuloResultados = `RESULTADOS OBJETIVO ${obj.numero||idx+1}`;
        const startR = startResultadosIndex;         // linha do subcabeçalho
        const endR   = startResultadosIndex + linhasResultados; // última linha de dados
        // escreve o rótulo na primeira linha de dados
        if(linhasResultados>0){
          aoa[startR+1][0]=rotuloResultados;
          merges.push({s:{r:startR+1,c:0},e:{r:endR,c:0}});
        }else{
          // nenhum dado, ainda assim mostrar rótulo em uma linha
          pushRow([rotuloResultados,'','','','','','','']);
          merges.push({s:{r:aoa.length-1,c:0},e:{r:aoa.length-1,c:0}});
        }

        // Bloco ATIVIDADES
        pushRow(['', 'Atividades', 'Lógica de Intervenção', 'Prazo e/ou periodicidade','','','','']);
        const atividades = Array.isArray(obj.atividades)?obj.atividades:[];
        if(atividades.length===0){
          pushRow(['', 'Sem atividades definidas','','','','','','']);
        }else{
          atividades.forEach((atv)=>{
            pushRow([
              '', 
              txt(atv.titulo||atv.descricao||''),
              txt(atv.logica_intervencao||atv.logica||''),
              txt(atv.prazo||atv.periodicidade||''),
              '','','',''
            ]);
          });
        }
      });

      const ws=XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols']=[
        {wch:28}, // Col A: rótulos de seção
        {wch:32}, // Resultados / Atividades
        {wch:34}, // Indicadores / Lógica
        {wch:28}, // Meios / Prazo
        {wch:4},{wch:4},{wch:4},{wch:4} // colunas auxiliares
      ];
      ws['!merges']=merges;
      XLSX.utils.book_append_sheet(wb,ws,'Marco Lógico');

      // Planilha Resumo simples
      const resumo=[
        ['MARCO LÓGICO - RESUMO'],[''],
        ['Nome do Projeto', nomeProjeto||''],
        ['Objetivo Geral', txt(marco.objetivo_geral||'')],
        ['Data', new Date().toLocaleDateString('pt-BR')]
      ];
      const wsR=XLSX.utils.aoa_to_sheet(resumo);
      wsR['!cols']=[{wch:20},{wch:70}];
      XLSX.utils.book_append_sheet(wb,wsR,'Resumo');

      const ts=Date.now();
      const nomeSeguro=(nomeProjeto||'Projeto').replace(/[^a-zA-Z0-9]/g,'_').substring(0,30);
      XLSX.writeFile(wb,`Marco_Logico_${nomeSeguro}_${ts}.xlsx`);
    }
  </script>
</body>
</html>

